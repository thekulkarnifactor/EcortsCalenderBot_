 {% extends "base.html" %} {% block title %}Case Details - {{ case.case_no }}{% endblock %} {% block content %}
<div class="container-fluid py-4">
    <!-- Back to Dashboard -->
    <div class="row mb-3">
        <div class="col-12">
            <a href="{{ url_for('dashboard') }}" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </div>

    <!-- Case Details Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-gavel"></i> Case Details
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5 class="text-primary">{{ case.case_no }}</h5>
                            <p class="mb-1"><strong>CINO:</strong> {{ case.cino }}</p>
                            <p class="mb-1"><strong>Type:</strong> {{ case.type_name }}</p>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <strong>Next Hearing Date:</strong>
                                    <button class="btn btn-sm btn-outline-primary" onclick="editHearingDate('{{ case.cino }}')">
                                        <i class="fas fa-edit me-1"></i>Edit Date
                                    </button>
                                </div>
                                <div class="hearing-date-container">
                                    <span id="hearing-date-{{ case.cino }}" class="badge bg-info fs-6 py-2 px-3">
                                        {{ case.date_next_list or 'Not scheduled' }}
                                    </span>
                                    <input type="date" id="hearing-date-input-{{ case.cino }}" class="form-control" value="{{ case.date_next_list if case.date_next_list and case.date_next_list != 'Not scheduled' else '' }}" style="display: none; max-width: 200px;" onchange="updateHearingDate('{{ case.cino }}', this.value)"
                                        onblur="updateHearingDate('{{ case.cino }}', this.value)" onkeydown="if(event.key==='Escape') cancelEditHearingDate('{{ case.cino }}')">

                                    <!-- Save/Cancel buttons for better UX -->
                                    <div id="hearing-date-actions-{{ case.cino }}" class="mt-2" style="display: none;">
                                        <button class="btn btn-sm btn-success me-2" onclick="saveHearingDate('{{ case.cino }}')">
                                            <i class="fas fa-check me-1"></i>Save
                                        </button>
                                        <button class="btn btn-sm btn-secondary" onclick="cancelEditHearingDate('{{ case.cino }}')">
                                            <i class="fas fa-times me-1"></i>Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <p class="mb-1"><strong>Purpose:</strong> {{ case.purpose_name }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Party Information -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-user"></i> Party Information
                    </h5>
                </div>
                <div class="card-body">
                    <!-- User Side Selection -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Select Your Side:</label>
                        <div class="row">
                            <div class="col-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="userSide" id="petitionerSide" value="petitioner" {{ 'checked' if case.user_side=='petitioner' else '' }}>
                                    <label class="form-check-label" for="petitionerSide">
                                        I am the Petitioner
                                    </label>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="userSide" id="respondentSide" value="respondent" {{ 'checked' if case.user_side=='respondent' else '' }}>
                                    <label class="form-check-label" for="respondentSide">
                                        I am the Respondent
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Party Names with conditional styling -->
                    <div class="row">
                        <div class="col-12 mb-3">
                            <label class="form-label">
                                <i class="fas fa-user-tie"></i> Petitioner
                            </label>
                            <div class="p-2 rounded" id="petitionerName" style="border: 2px solid #dee2e6;">
                                {{ case.petparty_name }}
                            </div>
                        </div>
                        <div class="col-12 mb-3">
                            <label class="form-label">
                                <i class="fas fa-user-shield"></i> Respondent
                            </label>
                            <div class="p-2 rounded" id="respondentName" style="border: 2px solid #dee2e6;">
                                {{ case.resparty_name }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-building"></i> Court Information
                    </h5>
                </div>
                <div class="card-body">
                    <p class="mb-2"><strong>Establishment:</strong></p>
                    <p class="text-muted small mb-3">{{ case.establishment_name }}</p>

                    <p class="mb-2"><strong>Court/Judge:</strong></p>
                    <p class="text-muted small mb-3">{{ case.court_no_desg_name }}</p>

                    <p class="mb-2"><strong>Location:</strong></p>
                    <p class="text-muted small">{{ case.district_name }}, {{ case.state_name }}</p>

                    {% if case.disp_name %}
                    <p class="mb-2"><strong>Disposition:</strong></p>
                    <p class="text-muted small">{{ case.disp_name }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Case Status and Changes -->
    {% if case.is_changed and case.change_summary %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-exclamation-triangle"></i> Recent Changes
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning">
                        {{ case.change_summary }}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Notes Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-sticky-note"></i> Your Notes
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <textarea class="form-control" id="caseNotes" rows="6" placeholder="Add your notes about this case...">{{ case.user_notes or '' }}</textarea>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-success" onclick="caseDetailSave()">
                            <i class="fas fa-save"></i> Save Changes
                        </button> {% if case.is_changed %}
                        <button type="button" class="btn btn-info" onclick="caseDetailMarkReviewed()">
                            <i class="fas fa-check"></i> Mark as Reviewed
                        </button> {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Raw Data (for debugging) -->
    {% if case.raw_data %}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <button class="btn btn-link p-0" type="button" data-bs-toggle="collapse" data-bs-target="#rawDataCollapse">
                            <i class="fas fa-code"></i> Raw Case Data
                        </button>
                    </h6>
                </div>
                <div class="collapse" id="rawDataCollapse">
                    <div class="card-body">
                        <pre class="small text-muted">{{ case.raw_data }}</pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mb-0">Saving case...</p>
            </div>
        </div>
    </div>
</div>

<script>
    // CASE DETAIL PAGE - ISOLATED JAVASCRIPT FUNCTIONS
    // These function names are completely different from app.js to avoid conflicts

    console.log('Case detail page JavaScript loaded');

    document.addEventListener('DOMContentLoaded', function() {
        console.log('Case detail page DOM loaded');
        updatePartyHighlight();

        // Listen for user side changes
        document.querySelectorAll('input[name="userSide"]').forEach(radio => {
            radio.addEventListener('change', updatePartyHighlight);
        });
    });

    function updatePartyHighlight() {
        const petitionerDiv = document.getElementById('petitionerName');
        const respondentDiv = document.getElementById('respondentName');
        const selectedSide = document.querySelector('input[name="userSide"]:checked');

        // Reset styles
        petitionerDiv.style.border = '2px solid #dee2e6';
        petitionerDiv.style.backgroundColor = '';
        respondentDiv.style.border = '2px solid #dee2e6';
        respondentDiv.style.backgroundColor = '';

        if (selectedSide) {
            if (selectedSide.value === 'petitioner') {
                petitionerDiv.style.border = '2px solid #dc3545';
                petitionerDiv.style.backgroundColor = 'rgba(220, 53, 69, 0.1)';
            } else if (selectedSide.value === 'respondent') {
                respondentDiv.style.border = '2px solid #dc3545';
                respondentDiv.style.backgroundColor = 'rgba(220, 53, 69, 0.1)';
            }
        }
    }

    function showLoading() {
        const modal = new bootstrap.Modal(document.getElementById('loadingModal'));
        modal.show();
    }

    function hideLoading() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('loadingModal'));
        if (modal) modal.hide();
    }

    function showAlert(message, type = 'info') {
        // Remove existing alerts
        document.querySelectorAll('.alert.position-fixed').forEach(alert => alert.remove());

        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

        document.body.appendChild(alertDiv);

        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }

    // UNIQUE FUNCTION NAMES FOR CASE DETAIL PAGE
    function caseDetailSave() {
        console.log('caseDetailSave function called');

        const notes = document.getElementById('caseNotes').value;
        const userSide = document.querySelector('input[name="userSide"]:checked');

        showLoading();

        const updateData = {
            notes: notes,
            updates: {}
        };

        if (userSide) {
            updateData.updates.user_side = userSide.value;
        }

        console.log('Sending update data:', updateData);

        fetch(`/case/{{ case.cino }}/update`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updateData)
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                console.log('Response received:', data);
                if (data.error) {
                    showAlert(data.error, 'danger');
                } else {
                    showAlert('Case saved successfully!', 'success');
                    // Refresh page after 1 second to show updated status
                    setTimeout(() => window.location.reload(), 1000);
                }
            })
            .catch(error => {
                hideLoading();
                console.error('Save error:', error);
                showAlert('Failed to save case: ' + error.message, 'danger');
            });
    }

    function caseDetailMarkReviewed() {
        console.log('caseDetailMarkReviewed function called');

        showLoading();

        fetch(`/case/{{ case.cino }}/mark_reviewed`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                console.log('Mark reviewed response:', data);
                if (data.error) {
                    showAlert(data.error, 'danger');
                } else {
                    showAlert('Case marked as reviewed!', 'success');
                    // Refresh page after 1 second to show updated status
                    setTimeout(() => window.location.reload(), 1000);
                }
            })
            .catch(error => {
                hideLoading();
                console.error('Mark reviewed error:', error);
                showAlert('Failed to mark as reviewed: ' + error.message, 'danger');
            });
    }
</script>

{% endblock %}