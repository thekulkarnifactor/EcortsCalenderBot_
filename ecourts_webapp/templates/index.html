{% extends "base.html" %} {% block title %}Date Joshi and Associates Case Management Dashboard{% endblock %} {% block content %}

<div class="container-fluid">
    <!-- Alerts placeholder -->
    <div id="creativeAlertContainer"></div>

    <!-- Page header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-balance-scale"></i> Date Joshi and Associates</h2>
        <div class="d-flex gap-2">
            <input type="file" id="fileInput" accept=".txt" style="display:none;">
            <label for="fileInput" class="btn btn-primary">
                <i class="fas fa-upload me-2"></i>Upload myCases.txt
            </label>
            <a href="/add_case" class="btn btn-success">
                <i class="fas fa-plus me-2"></i>Add New Case
            </a>
            <button type="button" class="btn btn-primary" onclick="showCalendarActionModal()">
                <i class="fas fa-calendar-plus me-2"></i>Calendar Actions
            </button>
            <button type="button" class="btn btn-danger" onclick="showDeleteAllModal()">
                <i class="fas fa-trash-alt me-2"></i>Delete ALL Cases
            </button>
        </div>
    </div>

    <!-- Stats cards -->
    <div class="row mb-4">
        <div class="col-md">
            <div class="card border-primary text-primary text-center">
                <div class="card-body">
                    <div class="fs-5">Total Cases</div>
                    <div class="display-6">{{ total_cases }}</div>
                </div>
            </div>
        </div>
        <div class="col-md">
            <div class="card border-warning text-warning text-center">
                <div class="card-body">
                    <div class="fs-5">Changed</div>
                    <div class="display-6">{{ changed_cases_count }}</div>
                </div>
            </div>
        </div>
        <div class="col-md">
            <div class="card border-success text-success text-center">
                <div class="card-body">
                    <div class="fs-5">Reviewed</div>
                    <div class="display-6">{{ reviewed_cases_count }}</div>
                </div>
            </div>
        </div>
        <div class="col-md">
            <div class="card border-info text-info text-center">
                <div class="card-body">
                    <div class="fs-5">Upcoming</div>
                    <div class="display-6">{{ upcoming_hearings_count }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter Controls -->
    <div class="row mb-3">
        <div class="col-md-4 mb-2">
            <input type="text" class="form-control" id="searchInput" placeholder="Search case, party, or number..." onkeyup="handleSearch()">
        </div>
        <div class="col-md-2 mb-2">
            <input type="date" class="form-control" id="dateFromInput" onchange="handleSearch()">
        </div>
        <div class="col-md-2 mb-2">
            <input type="date" class="form-control" id="dateToInput" onchange="handleSearch()">
        </div>
        <div class="col-md-2 mb-2">
            <button class="btn btn-secondary w-100" onclick="clearAllFilters()">
                <i class="fas fa-times me-2"></i> Clear
            </button>
        </div>
        <div class="col-md-2 mb-2 d-flex align-items-center">
            <span>Results: <span id="searchResultsCount" class="badge bg-primary">{{ total_cases }}</span></span>
        </div>
    </div>

    <!-- Date Filter Buttons - FIXED: Added "All" button -->
    <div class="mb-3" id="dateFilterGroup">
        <button class="btn btn-outline-secondary btn-sm active" onclick="setDateFilter('all')">All</button>
        <button class="btn btn-outline-secondary btn-sm" onclick="setDateFilter('today')">Today</button>
        <button class="btn btn-outline-secondary btn-sm" onclick="setDateFilter('thisWeek')">This Week</button>
        <button class="btn btn-outline-secondary btn-sm" onclick="setDateFilter('thisMonth')">This Month</button>
        <button class="btn btn-outline-secondary btn-sm" onclick="setDateFilter('nextWeek')">Next Week</button>
    </div>

    <!-- Bulk Actions Container -->
    <div id="bulkActionsContainer" style="display:none;" class="alert alert-primary shadow-sm mb-3">
        <div class="d-flex gap-2 align-items-center">
            <i class="fas fa-check-square text-primary"></i>
            <span id="selectedCasesText" class="fw-bold">0 cases selected</span>
            <div class="ms-auto d-flex gap-2">
                <button class="btn btn-success btn-sm" id="bulkMarkReviewedBtn" onclick="executeBulkAction('mark_reviewed')" disabled>
                    <i class="fas fa-check me-2"></i>Mark Reviewed
                </button>
                <button class="btn btn-warning btn-sm" id="bulkRemoveReviewedBtn" onclick="executeBulkAction('remove_from_reviewed')" disabled>
                    <i class="fas fa-undo me-2"></i>Remove from Reviewed
                </button>
                <button class="btn btn-primary btn-sm" onclick="showCalendarActionModal()" id="bulkCalendarBtn" disabled>
                    <i class="fas fa-calendar me-2"></i>Calendar Actions
                </button>
            </div>
        </div>
    </div>

    <!-- Global Select All Button -->
    <div class="d-flex justify-content-end mb-2">
        <button class="btn btn-outline-primary" id="selectAllGlobalBtn" onclick="handleGlobalSelectAll()">
            <span id="globalSelectAllText">Select All</span>
        </button>
    </div>

    <!-- Tab Navigation -->
    <ul class="nav nav-tabs mb-3" id="casesTabs" role="tablist">
        <li class="nav-item flex-fill" role="presentation">
            <button class="nav-link active w-100" id="all-cases-tab" data-bs-toggle="tab" data-bs-target="#all-cases" type="button" onclick="switchTab('all-cases')">
                All Cases 
                <span class="badge bg-light text-dark">{{ total_cases }}</span>
            </button>
        </li>
        <li class="nav-item flex-fill" role="presentation">
            <button class="nav-link w-100" id="changed-cases-tab" data-bs-toggle="tab" data-bs-target="#changed-cases" type="button" onclick="switchTab('changed-cases')">
                Changed 
                <span class="badge bg-warning text-dark">{{ changed_cases_count }}</span>
            </button>
        </li>
        <li class="nav-item flex-fill" role="presentation">
            <button class="nav-link w-100" id="reviewed-cases-tab" data-bs-toggle="tab" data-bs-target="#reviewed-cases" type="button" onclick="switchTab('reviewed-cases')">
                Reviewed 
                <span class="badge bg-success text-white">{{ reviewed_cases_count }}</span>
            </button>
        </li>
        <li class="nav-item flex-fill" role="presentation">
            <button class="nav-link w-100" id="upcoming-cases-tab" data-bs-toggle="tab" data-bs-target="#upcoming-cases" type="button" onclick="switchTab('upcoming-cases')">
                Upcoming 
                <span class="badge bg-info text-white">{{ upcoming_hearings_count }}</span>
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="casesTabContent">
        <!-- All Cases Tab -->
        <div class="tab-pane fade show active" id="all-cases" role="tabpanel">
            <div class="row" id="allCasesContainer">
                {% for case in cases %}
                <div class="col-xl-4 col-lg-6 col-md-6 mb-4">
                    <div class="card case-card" data-cino="{{ case.cino }}" data-case-no="{{ case.case_no or '' }}" data-petitioner="{{ case.petparty_name or '' }}" data-respondent="{{ case.resparty_name or '' }}" data-establishment="{{ case.establishment_name or '' }}"
                        data-court="{{ case.court_no_desg_name or '' }}" data-type="{{ case.type_name or '' }}" data-next-date="{{ case.date_next_list or '' }}">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div class="form-check">
                                <input class="form-check-input case-selection" type="checkbox" data-cino="{{ case.cino }}" onchange="updateCaseSelection()">
                                <label class="form-check-label fw-bold">
                                    {{ case.case_no or 'N/A' }}
                                </label>
                            </div>
                            {% if case.is_changed %}
                            <span class="badge bg-warning text-dark">Changed</span> {% else %}
                            <span class="badge bg-success text-white">Reviewed</span> {% endif %}
                        </div>
                        <div class="card-body">
                            <h6 class="card-title text-primary">{{ case.case_no or 'N/A' }}</h6>
                            <div class="case-parties row mb-2">
                                <div class="col-6">
                                    <small class="text-muted">Petitioner:</small>
                                    <div class="fw-medium">{{ case.petparty_name or 'N/A' }}</div>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Respondent:</small>
                                    <div class="fw-medium">{{ case.resparty_name or 'N/A' }}</div>
                                </div>
                            </div>
                            <div class="case-details mb-2">
                                <small class="text-muted">Court:</small>
                                <div>{{ case.court_no_desg_name or 'N/A' }}</div>
                                <small class="text-muted mt-1">Next Hearing:</small>
                                <div class="input-group input-group-sm">
                                    <input type="date" class="form-control form-control-sm hearing-date-input" value="{{ case.date_next_list or '' }}" data-cino="{{ case.cino }}" onchange="updateHearingDate('{{ case.cino }}', this.value)">
                                    <button class="btn btn-outline-secondary btn-sm" type="button" onclick="clearHearingDate('{{ case.cino }}')">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <small class="text-muted mt-1">Type:</small>
                                <div>{{ case.type_name or 'N/A' }}</div>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">Notes:</small>
                                <textarea class="form-control notes-input" rows="2" placeholder="Add your notes here...">{{ case.user_notes or '' }}</textarea>
                            </div>
                        </div>
                        <div class="card-footer">
                            <div class="d-flex gap-2 justify-content-between">
                                <div class="d-flex gap-1">
                                    <button class="btn btn-primary btn-sm" onclick="openCaseDetail('{{ case.cino }}')">
                                        <i class="fas fa-eye me-2"></i> View
                                    </button> {% if case.is_changed %}
                                    <button class="btn btn-success btn-sm" onclick="markAsReviewed('{{ case.cino }}')">
                                            <i class="fas fa-check me-2"></i> Mark Reviewed
                                        </button> {% else %}
                                    <button class="btn btn-outline-warning btn-sm" onclick="removeFromReviewed('{{ case.cino }}')">
                                            <i class="fas fa-undo me-2"></i> Unmark
                                        </button> {% endif %}
                                </div>
                                <div class="d-flex align-items-center">
                                    {% if case.user_side %}
                                    <span class="badge bg-info">{{ case.user_side.title() }}</span> {% else %}
                                    <button class="btn btn-outline-secondary btn-sm" onclick="showUserSideModal('{{ case.cino }}', '')">
                                            <i class="fas fa-user-tag me-2"></i> Set Side
                                        </button> {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Changed Cases Tab -->
        <div class="tab-pane fade" id="changed-cases" role="tabpanel">
            <div class="row" id="changedCasesContainer">
                {% for case in changed_cases %}
                <div class="col-xl-4 col-lg-6 col-md-6 mb-4">
                    <div class="card case-card" data-cino="{{ case.cino }}" data-case-no="{{ case.case_no or '' }}" data-petitioner="{{ case.petparty_name or '' }}" data-respondent="{{ case.resparty_name or '' }}" data-establishment="{{ case.establishment_name or '' }}"
                        data-court="{{ case.court_no_desg_name or '' }}" data-type="{{ case.type_name or '' }}" data-next-date="{{ case.date_next_list or '' }}">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div class="form-check">
                                <input class="form-check-input case-selection" type="checkbox" data-cino="{{ case.cino }}" onchange="updateCaseSelection()">
                                <label class="form-check-label fw-bold">
                                    {{ case.case_no or 'N/A' }}
                                </label>
                            </div>
                            <span class="badge bg-warning text-dark">Changed</span>
                        </div>
                        <div class="card-body">
                            <h6 class="card-title text-primary">{{ case.case_no or 'N/A' }}</h6>
                            <div class="case-parties row mb-2">
                                <div class="col-6">
                                    <small class="text-muted">Petitioner:</small>
                                    <div class="fw-medium">{{ case.petparty_name or 'N/A' }}</div>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Respondent:</small>
                                    <div class="fw-medium">{{ case.resparty_name or 'N/A' }}</div>
                                </div>
                            </div>
                            <div class="case-details mb-2">
                                <small class="text-muted">Court:</small>
                                <div>{{ case.court_no_desg_name or 'N/A' }}</div>
                                <small class="text-muted mt-1">Next Hearing:</small>
                                <div class="input-group input-group-sm">
                                    <input type="date" class="form-control form-control-sm hearing-date-input" value="{{ case.date_next_list or '' }}" data-cino="{{ case.cino }}" onchange="updateHearingDate('{{ case.cino }}', this.value)">
                                    <button class="btn btn-outline-secondary btn-sm" type="button" onclick="clearHearingDate('{{ case.cino }}')">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <small class="text-muted mt-1">Type:</small>
                                <div>{{ case.type_name or 'N/A' }}</div>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">Notes:</small>
                                <textarea class="form-control notes-input" rows="2" placeholder="Add your notes here...">{{ case.user_notes or '' }}</textarea>
                            </div>
                        </div>
                        <div class="card-footer">
                            <div class="d-flex gap-2 justify-content-between">
                                <div class="d-flex gap-1">
                                    <button class="btn btn-primary btn-sm" onclick="openCaseDetail('{{ case.cino }}')">
                                        <i class="fas fa-eye me-2"></i> View
                                    </button>
                                    <button class="btn btn-success btn-sm" onclick="markAsReviewed('{{ case.cino }}')">
                                        <i class="fas fa-check me-2"></i> Mark Reviewed
                                    </button>
                                </div>
                                <div class="d-flex align-items-center">
                                    {% if case.user_side %}
                                    <span class="badge bg-info">{{ case.user_side.title() }}</span> {% else %}
                                    <button class="btn btn-outline-secondary btn-sm" onclick="showUserSideModal('{{ case.cino }}', '')">
                                            <i class="fas fa-user-tag me-2"></i> Set Side
                                        </button> {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Reviewed Cases Tab -->
        <div class="tab-pane fade" id="reviewed-cases" role="tabpanel">
            <div class="row" id="reviewedCasesContainer">
                {% for case in reviewed_cases %}
                <div class="col-xl-4 col-lg-6 col-md-6 mb-4">
                    <div class="card case-card" data-cino="{{ case.cino }}" data-case-no="{{ case.case_no or '' }}" data-petitioner="{{ case.petparty_name or '' }}" data-respondent="{{ case.resparty_name or '' }}" data-establishment="{{ case.establishment_name or '' }}"
                        data-court="{{ case.court_no_desg_name or '' }}" data-type="{{ case.type_name or '' }}" data-next-date="{{ case.date_next_list or '' }}">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div class="form-check">
                                <input class="form-check-input case-selection" type="checkbox" data-cino="{{ case.cino }}" onchange="updateCaseSelection()">
                                <label class="form-check-label fw-bold">
                                    {{ case.case_no or 'N/A' }}
                                </label>
                            </div>
                            <span class="badge bg-success text-white">Reviewed</span>
                        </div>
                        <div class="card-body">
                            <h6 class="card-title text-primary">{{ case.case_no or 'N/A' }}</h6>
                            <div class="case-parties row mb-2">
                                <div class="col-6">
                                    <small class="text-muted">Petitioner:</small>
                                    <div class="fw-medium">{{ case.petparty_name or 'N/A' }}</div>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Respondent:</small>
                                    <div class="fw-medium">{{ case.resparty_name or 'N/A' }}</div>
                                </div>
                            </div>
                            <div class="case-details mb-2">
                                <small class="text-muted">Court:</small>
                                <div>{{ case.court_no_desg_name or 'N/A' }}</div>
                                <small class="text-muted mt-1">Next Hearing:</small>
                                <div class="input-group input-group-sm">
                                    <input type="date" class="form-control form-control-sm hearing-date-input" value="{{ case.date_next_list or '' }}" data-cino="{{ case.cino }}" onchange="updateHearingDate('{{ case.cino }}', this.value)">
                                    <button class="btn btn-outline-secondary btn-sm" type="button" onclick="clearHearingDate('{{ case.cino }}')">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <small class="text-muted mt-1">Type:</small>
                                <div>{{ case.type_name or 'N/A' }}</div>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">Notes:</small>
                                <textarea class="form-control notes-input" rows="2" placeholder="Add your notes here...">{{ case.user_notes or '' }}</textarea>
                            </div>
                        </div>
                        <div class="card-footer">
                            <div class="d-flex gap-2 justify-content-between">
                                <div class="d-flex gap-1">
                                    <button class="btn btn-primary btn-sm" onclick="openCaseDetail('{{ case.cino }}')">
                                        <i class="fas fa-eye me-2"></i> View
                                    </button>
                                    <button class="btn btn-outline-warning btn-sm" onclick="removeFromReviewed('{{ case.cino }}')">
                                        <i class="fas fa-undo me-2"></i> Unmark
                                    </button>
                                </div>
                                <div class="d-flex align-items-center">
                                    {% if case.user_side %}
                                    <span class="badge bg-info">{{ case.user_side.title() }}</span> {% else %}
                                    <button class="btn btn-outline-secondary btn-sm" onclick="showUserSideModal('{{ case.cino }}', '')">
                                            <i class="fas fa-user-tag me-2"></i> Set Side
                                        </button> {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Upcoming Cases Tab -->
        <div class="tab-pane fade" id="upcoming-cases" role="tabpanel">
            <div class="row" id="upcomingCasesContainer">
                {% for case in upcoming_cases %}
                <div class="col-xl-4 col-lg-6 col-md-6 mb-4">
                    <div class="card case-card" data-cino="{{ case.cino }}" data-case-no="{{ case.case_no or '' }}" data-petitioner="{{ case.petparty_name or '' }}" data-respondent="{{ case.resparty_name or '' }}" data-establishment="{{ case.establishment_name or '' }}"
                        data-court="{{ case.court_no_desg_name or '' }}" data-type="{{ case.type_name or '' }}" data-next-date="{{ case.date_next_list or '' }}">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div class="form-check">
                                <input class="form-check-input case-selection" type="checkbox" data-cino="{{ case.cino }}" onchange="updateCaseSelection()">
                                <label class="form-check-label fw-bold">
                                    {{ case.case_no or 'N/A' }}
                                </label>
                            </div>
                            <span class="badge bg-info text-white">Upcoming</span>
                        </div>
                        <div class="card-body">
                            <h6 class="card-title text-primary">{{ case.case_no or 'N/A' }}</h6>
                            <div class="case-parties row mb-2">
                                <div class="col-6">
                                    <small class="text-muted">Petitioner:</small>
                                    <div class="fw-medium">{{ case.petparty_name or 'N/A' }}</div>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Respondent:</small>
                                    <div class="fw-medium">{{ case.resparty_name or 'N/A' }}</div>
                                </div>
                            </div>
                            <div class="case-details mb-2">
                                <small class="text-muted">Court:</small>
                                <div>{{ case.court_no_desg_name or 'N/A' }}</div>
                                <small class="text-muted mt-1">Next Hearing:</small>
                                <div class="input-group input-group-sm">
                                    <input type="date" class="form-control form-control-sm hearing-date-input" value="{{ case.date_next_list or '' }}" data-cino="{{ case.cino }}" onchange="updateHearingDate('{{ case.cino }}', this.value)">
                                    <button class="btn btn-outline-secondary btn-sm" type="button" onclick="clearHearingDate('{{ case.cino }}')">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <small class="text-muted mt-1">Type:</small>
                                <div>{{ case.type_name or 'N/A' }}</div>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">Notes:</small>
                                <textarea class="form-control notes-input" rows="2" placeholder="Add your notes here...">{{ case.user_notes or '' }}</textarea>
                            </div>
                        </div>
                        <div class="card-footer">
                            <div class="d-flex gap-2 justify-content-between">
                                <div class="d-flex gap-1">
                                    <button class="btn btn-primary btn-sm" onclick="openCaseDetail('{{ case.cino }}')">
                                        <i class="fas fa-eye me-2"></i> View
                                    </button> {% if case.is_changed %}
                                    <button class="btn btn-success btn-sm" onclick="markAsReviewed('{{ case.cino }}')">
                                            <i class="fas fa-check me-2"></i> Mark Reviewed
                                        </button> {% else %}
                                    <button class="btn btn-outline-warning btn-sm" onclick="removeFromReviewed('{{ case.cino }}')">
                                            <i class="fas fa-undo me-2"></i> Unmark
                                        </button> {% endif %}
                                </div>
                                <div class="d-flex align-items-center">
                                    {% if case.user_side %}
                                    <span class="badge bg-info">{{ case.user_side.title() }}</span> {% else %}
                                    <button class="btn btn-outline-secondary btn-sm" onclick="showUserSideModal('{{ case.cino }}', '')">
                                            <i class="fas fa-user-tag me-2"></i> Set Side
                                        </button> {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Calendar Action Modal -->
<div class="modal fade" id="calendarActionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-calendar-alt me-2"></i>Calendar Actions for Cases
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card border-info">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0">Selected Cases</h6>
                            </div>
                            <div class="card-body text-center">
                                <h3 class="text-info" id="modalSelectedCount">0</h3>
                                <p class="mb-0">Cases Selected</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-secondary">
                            <div class="card-header bg-secondary text-white">
                                <h6 class="mb-0">All Cases in Tab</h6>
                            </div>
                            <div class="card-body text-center">
                                <h3 class="text-secondary" id="modalAllCount">0</h3>
                                <p class="mb-0">Total in Current Tab</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <button class="btn btn-success w-100 mb-2" onclick="executeCalendarAction('create', 'selected')">
                            <i class="fas fa-calendar-plus me-2"></i>Create Calendar for Selected
                        </button>
                        <button class="btn btn-outline-danger w-100" onclick="executeCalendarAction('delete', 'selected')">
                            <i class="fas fa-calendar-times me-2"></i>Delete Events for Selected
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-primary w-100 mb-2" onclick="executeCalendarAction('create', 'all')">
                            <i class="fas fa-calendar-plus me-2"></i>Create Calendar for All
                        </button>
                        <button class="btn btn-outline-danger w-100" onclick="executeCalendarAction('delete', 'all')">
                            <i class="fas fa-calendar-times me-2"></i>Delete Events for All
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete ALL Cases Modal -->
<div class="modal fade" id="deleteAllModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>Delete ALL Cases & Calendar Events
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-2 fw-bold text-danger">This action cannot be undone.<br>All cases and related calendar events will be deleted.</p>
                <div class="form-check mb-2">
                    <input type="checkbox" class="form-check-input" id="confirmDeleteDataCheck" onchange="validateDeletionForm()">
                    <label class="form-check-label" for="confirmDeleteDataCheck">I understand the consequences.</label>
                </div>
                <div class="mb-2">
                    <input type="text" class="form-control" id="confirmationText" placeholder='Type "DELETE_ALL_FOREVER" to confirm' oninput="validateDeletionForm()">
                </div>
                <button class="btn btn-danger w-100" id="confirmDeleteAllBtn" onclick="executeDeleteAll()" disabled>
                    <i class="fas fa-trash me-2"></i> Confirm Delete ALL
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let selectedCases = new Set();
    let currentFilters = {
        search: '',
        dateFrom: '',
        dateTo: '',
        dateFilter: 'all'
    };

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        updateCaseSelection();

        // Initialize search event listeners
        const searchInput = document.getElementById('searchInput');
        const dateFromInput = document.getElementById('dateFromInput');
        const dateToInput = document.getElementById('dateToInput');

        if (searchInput) {
            searchInput.addEventListener('input', handleSearch);
            searchInput.addEventListener('keyup', handleSearch);
        }

        if (dateFromInput) {
            dateFromInput.addEventListener('change', handleSearch);
        }

        if (dateToInput) {
            dateToInput.addEventListener('change', handleSearch);
        }
    });

    // Update case selection tracking
    function updateCaseSelection() {
        selectedCases.clear();
        document.querySelectorAll('.case-selection:checked').forEach(cb => {
            selectedCases.add(cb.getAttribute('data-cino'));
        });

        const selectedCount = selectedCases.size;
        document.getElementById('selectedCasesText').textContent = `${selectedCount} cases selected`;

        const bulkContainer = document.getElementById('bulkActionsContainer');
        document.getElementById('bulkMarkReviewedBtn').disabled = selectedCount === 0;
        document.getElementById('bulkRemoveReviewedBtn').disabled = selectedCount === 0;
        document.getElementById('bulkCalendarBtn').disabled = selectedCount === 0;
        bulkContainer.style.display = selectedCount > 0 ? 'block' : 'none';
    }

    // Handle search filtering
    function handleSearch() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const dateFrom = document.getElementById('dateFromInput').value;
        const dateTo = document.getElementById('dateToInput').value;

        currentFilters.search = searchTerm;
        currentFilters.dateFrom = dateFrom;
        currentFilters.dateTo = dateTo;

        filterCases();
    }

    // Main filter function
    function filterCases() {
        const activeTab = document.querySelector('.tab-pane.active');
        const cases = activeTab.querySelectorAll('.case-card');
        let visibleCount = 0;

        cases.forEach(caseCard => {
            let isVisible = true;

            // Search filter
            if (currentFilters.search) {
                const searchableText = [
                    caseCard.getAttribute('data-cino') || '',
                    caseCard.getAttribute('data-case-no') || '',
                    caseCard.getAttribute('data-petitioner') || '',
                    caseCard.getAttribute('data-respondent') || '',
                    caseCard.getAttribute('data-establishment') || '',
                    caseCard.getAttribute('data-court') || '',
                    caseCard.getAttribute('data-type') || '',
                    (caseCard.querySelector('.notes-input') && caseCard.querySelector('.notes-input').value) || ''
                ].join(' ').toLowerCase();

                if (!searchableText.includes(currentFilters.search)) {
                    isVisible = false;
                }
            }

            // Date range filter
            if ((currentFilters.dateFrom || currentFilters.dateTo)) {
                const caseDate = caseCard.getAttribute('data-next-date');
                if (caseDate) {
                    try {
                        const caseDateObj = new Date(caseDate);
                        if (!isNaN(caseDateObj.getTime())) {
                            if (currentFilters.dateFrom) {
                                const fromDate = new Date(currentFilters.dateFrom);
                                if (caseDateObj < fromDate) {
                                    isVisible = false;
                                }
                            }
                            if (currentFilters.dateTo) {
                                const toDate = new Date(currentFilters.dateTo);
                                toDate.setHours(23, 59, 59, 999);
                                if (caseDateObj > toDate) {
                                    isVisible = false;
                                }
                            }
                        } else {
                            isVisible = false;
                        }
                    } catch (e) {
                        isVisible = false;
                    }
                } else if (currentFilters.dateFrom || currentFilters.dateTo) {
                    isVisible = false;
                }
            }

            // Show/hide the case
            const col = caseCard.closest('.col-xl-4, .col-lg-6, .col-md-6');
            if (col) {
                col.style.display = isVisible ? 'block' : 'none';
            }

            if (isVisible) {
                visibleCount++;
            }
        });

        // Update results count
        document.getElementById('searchResultsCount').textContent = visibleCount;
    }

    // Set date filter
    function setDateFilter(period) {
        // Remove active class from all buttons
        document.querySelectorAll('#dateFilterGroup .btn').forEach(btn => {
            btn.classList.remove('active');
        });

        // Add active class to clicked button
        event.target.classList.add('active');

        const today = new Date();
        let dateFrom = '';
        let dateTo = '';

        switch (period) {
            case 'today':
                dateFrom = dateTo = today.toISOString().split('T')[0];
                break;
            case 'thisWeek':
                const startOfWeek = new Date(today);
                startOfWeek.setDate(today.getDate() - today.getDay());
                const endOfWeek = new Date(today);
                endOfWeek.setDate(today.getDate() - today.getDay() + 6);
                dateFrom = startOfWeek.toISOString().split('T')[0];
                dateTo = endOfWeek.toISOString().split('T');
                break;
            case 'thisMonth':
                dateFrom = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T');
                dateTo = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T');
                break;
            case 'nextWeek':
                const nextWeekStart = new Date(today);
                nextWeekStart.setDate(today.getDate() + (7 - today.getDay()));
                const nextWeekEnd = new Date(nextWeekStart);
                nextWeekEnd.setDate(nextWeekStart.getDate() + 6);
                dateFrom = nextWeekStart.toISOString().split('T')[0];
                dateTo = nextWeekEnd.toISOString().split('T');
                break;
            case 'all':
            default:
                dateFrom = dateTo = '';
                break;
        }

        document.getElementById('dateFromInput').value = dateFrom;
        document.getElementById('dateToInput').value = dateTo;

        currentFilters.dateFilter = period;
        currentFilters.dateFrom = dateFrom;
        currentFilters.dateTo = dateTo;

        filterCases();
    }

    // Clear all filters
    function clearAllFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('dateFromInput').value = '';
        document.getElementById('dateToInput').value = '';

        // Reset date filter buttons
        document.querySelectorAll('#dateFilterGroup .btn').forEach(btn => {
            btn.classList.remove('active');
        });

        // Activate "All" button
        document.querySelector('[onclick="setDateFilter(\'all\')"]').classList.add('active');

        currentFilters = {
            search: '',
            dateFrom: '',
            dateTo: '',
            dateFilter: 'all'
        };

        filterCases();
    }

    // Switch tab
    function switchTab(tabName) {
        // Apply filters to new tab after a short delay to let Bootstrap handle tab switching
        setTimeout(() => {
            filterCases();
            updateCaseSelection();
        }, 100);
    }

    // Global select all
    function handleGlobalSelectAll() {
        const activeTab = document.querySelector('.tab-pane.active');
        const visibleCases = Array.from(activeTab.querySelectorAll('.case-card')).filter(card => {
            const col = card.closest('.col-xl-4, .col-lg-6, .col-md-6');
            return col && col.style.display !== 'none';
        });

        const visibleCheckboxes = visibleCases.map(card => card.querySelector('.case-selection'));
        const allChecked = visibleCheckboxes.every(cb => cb.checked);

        visibleCheckboxes.forEach(cb => {
            cb.checked = !allChecked;
        });

        document.getElementById('globalSelectAllText').textContent = allChecked ? 'Select All' : 'Deselect All';
        updateCaseSelection();
    }

    // Modal functions
    function validateDeletionForm() {
        const checkbox = document.getElementById('confirmDeleteDataCheck');
        const textInput = document.getElementById('confirmationText');
        const deleteButton = document.getElementById('confirmDeleteAllBtn');
        deleteButton.disabled = !(checkbox.checked && textInput.value.trim() === 'DELETE_ALL_FOREVER');
    }

    function executeDeleteAll() {
        const confirmation = document.getElementById('confirmationText').value.trim();

        if (confirmation !== 'DELETE_ALL_FOREVER') {
            showAlert('Please type "DELETE_ALL_FOREVER" to confirm', 'danger');
            return;
        }

        const deleteButton = document.getElementById('confirmDeleteAllBtn');
        const originalText = deleteButton.innerHTML;

        deleteButton.disabled = true;
        deleteButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Deleting...';

        fetch('/delete_all_cases_and_calendar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    confirmation: 'DELETE_ALL_FOREVER'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }

                showAlert('All cases and calendar events deleted successfully!', 'success');

                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('deleteAllModal'));
                if (modal) modal.hide();

                // Redirect to upload page after successful deletion
                setTimeout(() => {
                    window.location.href = '/upload_page';
                }, 2000);
            })
            .catch(error => {
                console.error('Delete all error:', error);
                showAlert('Failed to delete all cases: ' + error.message, 'danger');
            })
            .finally(() => {
                deleteButton.disabled = false;
                deleteButton.innerHTML = originalText;
            });
    }

    function showDeleteAllModal() {
        const modal = new bootstrap.Modal(document.getElementById('deleteAllModal'));
        modal.show();
    }

    function showCalendarActionModal() {
        const modal = new bootstrap.Modal(document.getElementById('calendarActionModal'));
        const selectedCount = selectedCases.size;
        const allCount = document.querySelectorAll('.tab-pane.active .case-card').length;
        document.getElementById('modalSelectedCount').textContent = selectedCount;
        document.getElementById('modalAllCount').textContent = allCount;
        modal.show();
    }

    // Case action functions (placeholders)
    function openCaseDetail(cino) {
        window.location.href = `/case/${cino}`;
    }

    function markAsReviewed(cino) {
        alert(`Mark case ${cino} as reviewed`);
    }

    function removeFromReviewed(cino) {
        alert(`Remove case ${cino} from reviewed`);
    }

    function updateHearingDate(cino, date) {
        console.log(`Update hearing date for ${cino} to ${date}`);
    }

    function clearHearingDate(cino) {
        const input = document.querySelector(`input[data-cino="${cino}"]`);
        if (input) input.value = '';
    }

    function executeBulkAction(action) {
        alert(`Execute bulk action: ${action} on ${selectedCases.size} cases`);
    }

    function extractCaseDataFromCard(caseCard) {
        const notesInput = caseCard.querySelector('.notes-input');
        const hearingDateInput = caseCard.querySelector('.hearing-date-input');

        return {
            cino: caseCard.getAttribute('data-cino') || '',
            case_no: caseCard.getAttribute('data-case-no') || '',
            petparty_name: caseCard.getAttribute('data-petitioner') || '',
            resparty_name: caseCard.getAttribute('data-respondent') || '',
            establishment_name: caseCard.getAttribute('data-establishment') || '',
            state_name: caseCard.getAttribute('data-state') || '',
            district_name: caseCard.getAttribute('data-district') || '',
            court_no_desg_name: caseCard.getAttribute('data-court') || '',
            type_name: caseCard.getAttribute('data-type') || '',
            date_next_list: hearingDateInput ? hearingDateInput.value : (caseCard.getAttribute('data-next-date') || ''),
            purpose_name: caseCard.getAttribute('data-purpose') || '',
            user_notes: notesInput ? notesInput.value : '',
            user_side: caseCard.getAttribute('data-user-side') || ''
        };
    }

    function executeCalendarAction(action, scope) {
        console.log(`Executing calendar action: ${action} for ${scope}`);

        // Close the modal first
        const modal = bootstrap.Modal.getInstance(document.getElementById('calendarActionModal'));
        if (modal) modal.hide();

        if (action === 'create') {
            // Prepare cases data based on scope
            let casesToProcess = [];
            const activeTab = document.querySelector('.tab-pane.active');

            if (scope === 'selected') {
                // Get selected cases
                const selectedCheckboxes = document.querySelectorAll('.case-selection:checked');
                selectedCheckboxes.forEach(checkbox => {
                    const caseCard = checkbox.closest('.case-card');
                    if (caseCard) {
                        casesToProcess.push(extractCaseDataFromCard(caseCard));
                    }
                });

                if (casesToProcess.length === 0) {
                    showAlert('No cases selected for calendar creation', 'warning');
                    return;
                }
            } else if (scope === 'all') {
                // Get all visible cases in current tab
                const visibleCases = activeTab.querySelectorAll('.case-card');
                visibleCases.forEach(caseCard => {
                    const container = caseCard.closest('.col-xl-4, .col-lg-6, .col-md-6');
                    if (container && container.style.display !== 'none') {
                        casesToProcess.push(extractCaseDataFromCard(caseCard));
                    }
                });
            }

            if (casesToProcess.length === 0) {
                showAlert('No cases available for calendar creation', 'warning');
                return;
            }

            // Show progress
            showAlert(`Creating calendar events for ${casesToProcess.length} cases...`, 'info');

            // Call the create calendar API
            fetch('/create_calendar_events', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        filter: scope === 'selected' ? 'selected_cases_only' : 'current_tab_all',
                        scope: scope,
                        cases: casesToProcess
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }

                    const message = `Calendar events created successfully! ${data.created} created, ${data.updated || 0} updated`;
                    showAlert(message, 'success');
                })
                .catch(error => {
                    console.error('Calendar creation error:', error);
                    showAlert('Failed to create calendar events: ' + error.message, 'danger');
                });

        } else if (action === 'delete') {
            // Handle calendar deletion
            let confirmMessage = '';
            if (scope === 'selected') {
                const selectedCount = document.querySelectorAll('.case-selection:checked').length;
                if (selectedCount === 0) {
                    showAlert('No cases selected for calendar deletion', 'warning');
                    return;
                }
                confirmMessage = `Delete calendar events for ${selectedCount} selected cases?`;
            } else {
                const allCount = document.querySelectorAll('.tab-pane.active .case-card').length;
                confirmMessage = `Delete calendar events for all ${allCount} cases in current tab?`;
            }

            showConfirm(confirmMessage, 'warning').then(confirmed => {
                if (!confirmed) return;

                if (scope === 'selected') {
                    // Get selected cases for deletion
                    let casesToDelete = [];
                    const selectedCheckboxes = document.querySelectorAll('.case-selection:checked');
                    selectedCheckboxes.forEach(checkbox => {
                        const caseCard = checkbox.closest('.case-card');
                        if (caseCard) {
                            casesToDelete.push(extractCaseDataFromCard(caseCard));
                        }
                    });

                    fetch('/delete_selected_calendar_events', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                cases: casesToDelete
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.error) {
                                throw new Error(data.error);
                            }
                            showAlert(`Deleted ${data.deleted} calendar events`, 'success');
                        })
                        .catch(error => {
                            showAlert('Failed to delete calendar events: ' + error.message, 'danger');
                        });
                } else {
                    // Delete all calendar events
                    fetch('/delete_calendar_events', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                method: 'auto'
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.error) {
                                throw new Error(data.error);
                            }
                            showAlert(`Deleted ${data.deleted} calendar events`, 'success');
                        })
                        .catch(error => {
                            showAlert('Failed to delete calendar events: ' + error.message, 'danger');
                        });
                }
            });
        }
    }

    function showAlert(message, type) {
        // If you have a custom alert system, use it
        if (typeof window.showAlert === 'function') {
            return window.showAlert(message, type);
        }

        // Fallback to console and basic alert
        console.log(`[${type.toUpperCase()}] ${message}`);
        alert(message);
    }

    // Custom confirm function
    function showConfirm(message, type) {
        // If you have a custom confirm system, use it
        if (typeof window.showConfirm === 'function') {
            return window.showConfirm(message, type);
        }

        // Fallback to standard confirm
        return Promise.resolve(confirm(message));
    }
</script>

<style>
    .nav-tabs .nav-item {
        position: relative;
        flex: 1;
    }
    
    .nav-tabs .nav-link {
        padding-right: 100px;
    }
    
    .nav-tabs .btn {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
    
    .hearing-date-input {
        font-size: 0.875rem;
    }
    
    #bulkActionsContainer {
        border-left: 4px solid var(--bs-primary);
    }
</style>
{% endblock %}