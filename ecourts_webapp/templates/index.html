{% extends "base.html" %} {% block title %}Date Joshi and Associates Case Management Dashboard{% endblock %} {% block content %}

<div class="container-fluid">
    <!-- Alerts placeholder -->
    <div id="creativeAlertContainer"></div>

    <!-- Page header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
            <a href="https://datejoshiandassociates.com/" target="_blank" style="text-decoration: none; color: inherit;">
                <i class="fas fa-balance-scale"></i> Date Joshi and Associates
            </a>
        </h2>
        <div class="d-flex gap-2">
            <input type="file" id="fileInput" accept=".txt" style="display:none;">
            <label for="fileInput" class="btn btn-primary">
                <i class="fas fa-upload me-2"></i>Upload myCases.txt
            </label>
            <a href="/add_case" class="btn btn-success">
                <i class="fas fa-plus me-2"></i>Add New Case
            </a>
            <button type="button" class="btn btn-primary" onclick="showCalendarActionModal()">
                <i class="fas fa-calendar-plus me-2"></i>Calendar Actions
            </button>
            <button type="button" class="btn btn-danger" onclick="showDeleteAllModal()">
                <i class="fas fa-trash-alt me-2"></i>Delete ALL Cases
            </button>
            <button type="button" class="btn btn-success" onclick="exportAllCasesAsTxt()" title="Export Cases to Text File">
                <i class="fas fa-download me-2"></i> Export Cases
            </button>
        </div>
    </div>

    <!-- Stats cards -->
    <div class="row mb-4">
        <div class="col-md">
            <div class="card border-primary text-primary text-center">
                <div class="card-body">
                    <div class="fs-5">Total Cases</div>
                    <div class="display-6">{{ total_cases }}</div>
                </div>
            </div>
        </div>
        <div class="col-md">
            <div class="card border-success text-success text-center">
                <div class="card-body">
                    <div class="fs-5">Active Cases</div>
                    <div class="display-6">{{ active_cases_count }}</div>
                </div>
            </div>
        </div>
        <!-- <div class="col-md">
            <div class="card border-danger text-danger text-center">
                <div class="card-body">
                    <div class="fs-5">Disposed Cases</div>
                    <div class="display-6">{{ disposed_cases_count }}</div>
                </div>
            </div>
        </div> -->
        <div class="col-md">
            <div class="card border-warning text-warning text-center">
                <div class="card-body">
                    <div class="fs-5">Changed</div>
                    <div class="display-6">{{ changed_cases_count }}</div>
                </div>
            </div>
        </div>
        <div class="col-md">
            <div class="card border-info text-info text-center">
                <div class="card-body">
                    <div class="fs-5">Upcoming</div>
                    <div class="display-6">{{ upcoming_hearings_count }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter Controls -->
    <div class="row mb-3">
        <div class="col-md-4 mb-2">
            <input type="text" class="form-control" id="searchInput" placeholder="Search case, party, or number..." onkeyup="handleSearch()">
        </div>
        <div class="col-md-2 mb-2">
            <input type="date" class="form-control" id="dateFromInput" onchange="handleSearch()">
        </div>
        <div class="col-md-2 mb-2">
            <input type="date" class="form-control" id="dateToInput" onchange="handleSearch()">
        </div>
        <div class="col-md-2 mb-2">
            <button class="btn btn-secondary w-100" onclick="clearAllFilters()">
                <i class="fas fa-times me-2"></i> Clear
            </button>
        </div>
        <div class="col-md-2 mb-2 d-flex align-items-center">
            <span>Results: <span id="searchResultsCount" class="badge bg-primary">{{ total_cases }}</span></span>
        </div>
    </div>

    <!-- Date Filter Buttons -->
    <div class="mb-3" id="dateFilterGroup">
        <button class="btn btn-outline-secondary btn-sm active" onclick="setDateFilter('all')">All</button>
        <button class="btn btn-outline-secondary btn-sm" onclick="setDateFilter('today')">Today</button>
        <button class="btn btn-outline-secondary btn-sm" onclick="setDateFilter('thisWeek')">This Week</button>
        <button class="btn btn-outline-secondary btn-sm" onclick="setDateFilter('thisMonth')">This Month</button>
        <button class="btn btn-outline-secondary btn-sm" onclick="setDateFilter('nextWeek')">Next Week</button>
    </div>

    <!-- Bulk Actions Container -->
    <div id="bulkActionsContainer" style="display:none;" class="alert alert-primary shadow-sm mb-3">
        <div class="d-flex gap-2 align-items-center">
            <i class="fas fa-check-square text-primary"></i>
            <span id="selectedCasesText" class="fw-bold">0 cases selected</span>
            <div class="ms-auto d-flex gap-2">
                <button class="btn btn-success btn-sm" id="bulkMarkReviewedBtn" onclick="executeBulkAction('mark_reviewed')" disabled>
                    <i class="fas fa-check me-2"></i>Mark Reviewed
                </button>
                <button class="btn btn-warning btn-sm" id="bulkRemoveReviewedBtn" onclick="executeBulkAction('remove_from_reviewed')" disabled>
                    <i class="fas fa-undo me-2"></i>Remove from Reviewed
                </button>
                <button class="btn btn-primary btn-sm" onclick="showCalendarActionModal()" id="bulkCalendarBtn" disabled>
                    <i class="fas fa-calendar me-2"></i>Calendar Actions
                </button>
            </div>
        </div>
    </div>

    <!-- Global Select All Button -->
    <div class="d-flex justify-content-end mb-2">
        <button class="btn btn-outline-primary" id="selectAllGlobalBtn" onclick="handleGlobalSelectAll()">
            <span id="globalSelectAllText">Select All</span>
        </button>
    </div>

    <!-- Tab Navigation -->
    <ul class="nav nav-tabs mb-3" id="casesTabs" role="tablist">
        <li class="nav-item flex-fill" role="presentation">
            <button class="nav-link active w-100" id="all-cases-tab" data-bs-toggle="tab" data-bs-target="#all-cases" type="button" onclick="switchTab('all-cases')">
            All Cases 
            <span class="badge bg-light text-dark" id="all-cases-count">{{ total_cases }}</span>
        </button>
        </li>
        <li class="nav-item flex-fill" role="presentation">
            <button class="nav-link w-100" id="active-cases-tab" data-bs-toggle="tab" data-bs-target="#active-cases" type="button" onclick="switchTab('active-cases')">
            Active Cases
            <span class="badge bg-info text-dark" id="active-cases-count">{{ active_cases_count }}</span>
        </button>
        </li>
        <li class="nav-item flex-fill" role="presentation">
            <button class="nav-link w-100" id="changed-cases-tab" data-bs-toggle="tab" data-bs-target="#changed-cases" type="button" onclick="switchTab('changed-cases')">
            Changed 
            <span class="badge bg-warning text-dark" id="changed-cases-count">{{ changed_cases_count }}</span>
        </button>
        </li>
        <li class="nav-item flex-fill" role="presentation">
            <button class="nav-link w-100" id="upcoming-cases-tab" data-bs-toggle="tab" data-bs-target="#upcoming-cases" type="button" onclick="switchTab('upcoming-cases')">
            Upcoming 
            <span class="badge bg-info text-white" id="upcoming-cases-count">{{ upcoming_hearings_count }}</span>
        </button>
        </li>
        <li class="nav-item flex-fill" role="presentation">
            <button class="nav-link w-100" id="reviewed-cases-tab" data-bs-toggle="tab" data-bs-target="#reviewed-cases" type="button" onclick="switchTab('reviewed-cases')">
            Reviewed 
            <span class="badge bg-success text-white" id="reviewed-cases-count">{{ reviewed_cases_count }}</span>
        </button>
        </li>
        <li class="nav-item flex-fill" role="presentation">
            <button class="nav-link w-100" id="disposed-cases-tab" data-bs-toggle="tab" data-bs-target="#disposed-cases" type="button" onclick="switchTab('disposed-cases')">
            Disposed 
            <span class="badge bg-danger text-white" id="disposed-cases-count">{{ disposed_cases_count }}</span>
        </button>
        </li>
    </ul>


    <!-- Tab Content -->
    <div class="tab-content" id="casesTabContent">
        <!-- All Cases Tab -->
        <div class="tab-pane fade show active" id="all-cases" role="tabpanel">
            <div class="row" id="allCasesContainer">
                {% for case in cases %}
                <div class="col-xl-4 col-lg-6 col-md-6 mb-4">
                    <div class="card case-card" data-cino="{{ case.cino }}" data-case-no="{{ case.case_no or '' }}" data-petitioner="{{ case.petparty_name or '' }}" data-respondent="{{ case.resparty_name or '' }}" data-establishment="{{ case.establishment_name or '' }}"
                        data-court="{{ case.court_no_desg_name or '' }}" data-type="{{ case.type_name or '' }}" data-next-date="{{ case.date_next_list or '' }}">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div class="form-check">
                                <input class="form-check-input case-selection" type="checkbox" data-cino="{{ case.cino }}" onchange="updateCaseSelection()">
                                <!-- <label class="form-check-label fw-bold">
                                    {{ case.case_no or 'N/A' }}
                                </label> -->
                            </div>
                            {% if case.is_changed %}
                            <span class="badge bg-warning text-dark">Changed</span> {% else %}
                            <span class="badge bg-success text-white">Reviewed</span> {% endif %}
                        </div>
                        <div class="card-body">
                            <h6 class="card-title text-primary">{{ case.case_no or 'N/A' }}</h6>
                            <div class="case-parties row mb-2">
                                <div class="col-6">
                                    <small class="text-muted">Petitioner:</small>
                                    <div class="fw-medium">{{ case.petparty_name or 'N/A' }}</div>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Respondent:</small>
                                    <div class="fw-medium">{{ case.resparty_name or 'N/A' }}</div>
                                </div>
                            </div>
                            <div class="case-details mb-2">
                                <small class="text-muted">Court:</small>
                                <div>{{ case.court_no_desg_name or 'N/A' }}</div>
                                <small class="text-muted mt-1">Next Hearing:</small>
                                <div class="input-group input-group-sm">
                                    <input type="date" class="form-control form-control-sm hearing-date-input" value="{{ case.date_next_list or '' }}" data-cino="{{ case.cino }}" onchange="updateHearingDate('{{ case.cino }}', this.value)">
                                    <button class="btn btn-outline-secondary btn-sm" type="button" onclick="clearHearingDate('{{ case.cino }}')">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <small class="text-muted mt-1">Type:</small>
                                <div>{{ case.type_name or 'N/A' }}</div>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">Notes:</small>
                                <textarea class="form-control notes-input" rows="2" placeholder="Add your notes here...">{{ case.user_notes or '' }}</textarea>
                            </div>
                        </div>
                        <div class="card-footer">
                            <div class="d-flex gap-2 justify-content-between">
                                <div class="d-flex gap-1">
                                    <button class="btn btn-primary btn-sm" onclick="openCaseDetail('{{ case.cino }}')">
                                        <i class="fas fa-eye me-2"></i> View
                                    </button> {% if case.is_changed %}
                                    <button class="btn btn-success btn-sm" onclick="markAsReviewed('{{ case.cino }}')">
                                        <i class="fas fa-check me-2"></i> Mark Reviewed
                                    </button> {% else %}
                                    <button class="btn btn-outline-warning btn-sm" onclick="removeFromReviewed('{{ case.cino }}')">
                                        <i class="fas fa-undo me-2"></i> Unmark
                                    </button> {% endif %}
                                    <!-- NEW: Save Changes Button -->
                                    <!-- <button class="btn btn-outline-primary btn-sm" onclick="saveCaseChanges('{{ case.cino }}')">
                                        <i class="fas fa-save me-2"></i> Save Changes
                                    </button> -->
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    {% if case.user_side %}
                                    <span class="badge bg-info">{{ case.user_side.title() }}</span> {% else %}
                                    <button class="btn btn-outline-secondary btn-sm" onclick="showUserSideModal('{{ case.cino }}', '')">
                <i class="fas fa-user-tag me-2"></i> Set Side
            </button> {% endif %}
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Active Cases Tab -->
        <div class="tab-pane fade" id="active-cases" role="tabpanel">
            <div class="row" id="activeCasesContainer">
                {% for case in active_cases %}
                <div class="col-xl-4 col-lg-6 col-md-6 mb-4">
                    <div class="card case-card" data-cino="{{ case.cino }}" data-case-no="{{ case.case_no or '' }}" data-petitioner="{{ case.petparty_name or '' }}" data-respondent="{{ case.resparty_name or '' }}" data-establishment="{{ case.establishment_name or '' }}"
                        data-court="{{ case.court_no_desg_name or '' }}" data-type="{{ case.type_name or '' }}" data-next-date="{{ case.date_next_list or '' }}">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div class="form-check">
                                <input class="form-check-input case-selection" type="checkbox" data-cino="{{ case.cino }}" onchange="updateCaseSelection()">
                                <label class="form-check-label fw-bold">
                                    {{ case.case_no or 'N/A' }}
                                </label>
                            </div>
                            <span class="badge bg-success text-white">Active</span>
                        </div>
                        <div class="card-body">
                            <h6 class="card-title text-primary">{{ case.case_no or 'N/A' }}</h6>
                            <div class="case-parties row mb-2">
                                <div class="col-6">
                                    <small class="text-muted">Petitioner:</small>
                                    <div class="fw-medium">{{ case.petparty_name or 'N/A' }}</div>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Respondent:</small>
                                    <div class="fw-medium">{{ case.resparty_name or 'N/A' }}</div>
                                </div>
                            </div>
                            <div class="case-details mb-2">
                                <small class="text-muted">Court:</small>
                                <div>{{ case.court_no_desg_name or 'N/A' }}</div>
                                <small class="text-muted mt-1">Next Hearing:</small>
                                <div class="input-group input-group-sm">
                                    <input type="date" class="form-control form-control-sm hearing-date-input" value="{{ case.date_next_list or '' }}" data-cino="{{ case.cino }}" onchange="updateHearingDate('{{ case.cino }}', this.value)">
                                    <button class="btn btn-outline-secondary btn-sm" type="button" onclick="clearHearingDate('{{ case.cino }}')">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <small class="text-muted mt-1">Type:</small>
                                <div>{{ case.type_name or 'N/A' }}</div>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">Notes:</small>
                                <textarea class="form-control notes-input" rows="2" placeholder="Add your notes here...">{{ case.user_notes or '' }}</textarea>
                            </div>
                        </div>
                        <div class="card-footer">
                            <div class="d-flex gap-2 justify-content-between">
                                <div class="d-flex gap-1">
                                    <button class="btn btn-primary btn-sm" onclick="openCaseDetail('{{ case.cino }}')">
                                        <i class="fas fa-eye me-2"></i> View
                                    </button>
                                    <button class="btn btn-success btn-sm" onclick="markAsReviewed('{{ case.cino }}')">
                                        <i class="fas fa-check me-2"></i> Mark Reviewed
                                    </button>
                                </div>
                                <div class="d-flex align-items-center">
                                    {% if case.user_side %}
                                    <span class="badge bg-info">{{ case.user_side.title() }}</span> {% else %}
                                    <button class="btn btn-outline-secondary btn-sm" onclick="showUserSideModal('{{ case.cino }}', '')">
                                            <i class="fas fa-user-tag me-2"></i> Set Side
                                        </button> {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Changed Cases Tab -->
        <div class="tab-pane fade" id="changed-cases" role="tabpanel">
            <div class="row" id="changedCasesContainer">
                {% for case in changed_cases %}
                <div class="col-xl-4 col-lg-6 col-md-6 mb-4">
                    <div class="card case-card" data-cino="{{ case.cino }}" data-case-no="{{ case.case_no or '' }}" data-petitioner="{{ case.petparty_name or '' }}" data-respondent="{{ case.resparty_name or '' }}" data-establishment="{{ case.establishment_name or '' }}"
                        data-court="{{ case.court_no_desg_name or '' }}" data-type="{{ case.type_name or '' }}" data-next-date="{{ case.date_next_list or '' }}">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div class="form-check">
                                <input class="form-check-input case-selection" type="checkbox" data-cino="{{ case.cino }}" onchange="updateCaseSelection()">
                                <label class="form-check-label fw-bold">
                                    {{ case.case_no or 'N/A' }}
                                </label>
                            </div>
                            <span class="badge bg-warning text-dark">Changed</span>
                        </div>
                        <div class="card-body">
                            <h6 class="card-title text-primary">{{ case.case_no or 'N/A' }}</h6>
                            <div class="case-parties row mb-2">
                                <div class="col-6">
                                    <small class="text-muted">Petitioner:</small>
                                    <div class="fw-medium">{{ case.petparty_name or 'N/A' }}</div>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Respondent:</small>
                                    <div class="fw-medium">{{ case.resparty_name or 'N/A' }}</div>
                                </div>
                            </div>
                            <div class="case-details mb-2">
                                <small class="text-muted">Court:</small>
                                <div>{{ case.court_no_desg_name or 'N/A' }}</div>
                                <small class="text-muted mt-1">Next Hearing:</small>
                                <div class="input-group input-group-sm">
                                    <input type="date" class="form-control form-control-sm hearing-date-input" value="{{ case.date_next_list or '' }}" data-cino="{{ case.cino }}" onchange="updateHearingDate('{{ case.cino }}', this.value)">
                                    <button class="btn btn-outline-secondary btn-sm" type="button" onclick="clearHearingDate('{{ case.cino }}')">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <small class="text-muted mt-1">Type:</small>
                                <div>{{ case.type_name or 'N/A' }}</div>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">Notes:</small>
                                <textarea class="form-control notes-input" rows="2" placeholder="Add your notes here...">{{ case.user_notes or '' }}</textarea>
                            </div>
                        </div>
                        <div class="card-footer">
                            <div class="d-flex gap-2 justify-content-between">
                                <div class="d-flex gap-1">
                                    <button class="btn btn-primary btn-sm" onclick="openCaseDetail('{{ case.cino }}')">
                                        <i class="fas fa-eye me-2"></i> View
                                    </button>
                                    <button class="btn btn-success btn-sm" onclick="markAsReviewed('{{ case.cino }}')">
                                        <i class="fas fa-check me-2"></i> Mark Reviewed
                                    </button>
                                </div>
                                <div class="d-flex align-items-center">
                                    {% if case.user_side %}
                                    <span class="badge bg-info">{{ case.user_side.title() }}</span> {% else %}
                                    <button class="btn btn-outline-secondary btn-sm" onclick="showUserSideModal('{{ case.cino }}', '')">
                                            <i class="fas fa-user-tag me-2"></i> Set Side
                                        </button> {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Reviewed Cases Tab -->
        <div class="tab-pane fade" id="reviewed-cases" role="tabpanel">
            <div class="row" id="reviewedCasesContainer">
                {% for case in reviewed_cases %}
                <div class="col-xl-4 col-lg-6 col-md-6 mb-4">
                    <div class="card case-card" data-cino="{{ case.cino }}" data-case-no="{{ case.case_no or '' }}" data-petitioner="{{ case.petparty_name or '' }}" data-respondent="{{ case.resparty_name or '' }}" data-establishment="{{ case.establishment_name or '' }}"
                        data-court="{{ case.court_no_desg_name or '' }}" data-type="{{ case.type_name or '' }}" data-next-date="{{ case.date_next_list or '' }}">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div class="form-check">
                                <input class="form-check-input case-selection" type="checkbox" data-cino="{{ case.cino }}" onchange="updateCaseSelection()">
                                <label class="form-check-label fw-bold">
                                    {{ case.case_no or 'N/A' }}
                                </label>
                            </div>
                            <span class="badge bg-success text-white">Reviewed</span>
                        </div>
                        <div class="card-body">
                            <h6 class="card-title text-primary">{{ case.case_no or 'N/A' }}</h6>
                            <div class="case-parties row mb-2">
                                <div class="col-6">
                                    <small class="text-muted">Petitioner:</small>
                                    <div class="fw-medium">{{ case.petparty_name or 'N/A' }}</div>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Respondent:</small>
                                    <div class="fw-medium">{{ case.resparty_name or 'N/A' }}</div>
                                </div>
                            </div>
                            <div class="case-details mb-2">
                                <small class="text-muted">Court:</small>
                                <div>{{ case.court_no_desg_name or 'N/A' }}</div>
                                <small class="text-muted mt-1">Next Hearing:</small>
                                <div class="input-group input-group-sm">
                                    <input type="date" class="form-control form-control-sm hearing-date-input" value="{{ case.date_next_list or '' }}" data-cino="{{ case.cino }}" onchange="updateHearingDate('{{ case.cino }}', this.value)">
                                    <button class="btn btn-outline-secondary btn-sm" type="button" onclick="clearHearingDate('{{ case.cino }}')">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <small class="text-muted mt-1">Type:</small>
                                <div>{{ case.type_name or 'N/A' }}</div>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">Notes:</small>
                                <textarea class="form-control notes-input" rows="2" placeholder="Add your notes here...">{{ case.user_notes or '' }}</textarea>
                            </div>
                        </div>
                        <div class="card-footer">
                            <div class="d-flex gap-2 justify-content-between">
                                <div class="d-flex gap-1">
                                    <button class="btn btn-primary btn-sm" onclick="openCaseDetail('{{ case.cino }}')">
                                        <i class="fas fa-eye me-2"></i> View
                                    </button>
                                    <button class="btn btn-outline-warning btn-sm" onclick="removeFromReviewed('{{ case.cino }}')">
                                        <i class="fas fa-undo me-2"></i> Unmark
                                    </button>
                                </div>
                                <div class="d-flex align-items-center">
                                    {% if case.user_side %}
                                    <span class="badge bg-info">{{ case.user_side.title() }}</span> {% else %}
                                    <button class="btn btn-outline-secondary btn-sm" onclick="showUserSideModal('{{ case.cino }}', '')">
                                            <i class="fas fa-user-tag me-2"></i> Set Side
                                        </button> {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Upcoming Cases Tab -->
        <div class="tab-pane fade" id="upcoming-cases" role="tabpanel">
            <div class="row" id="upcomingCasesContainer">
                {% for case in upcoming_cases %}
                <div class="col-xl-4 col-lg-6 col-md-6 mb-4">
                    <div class="card case-card" data-cino="{{ case.cino }}" data-case-no="{{ case.case_no or '' }}" data-petitioner="{{ case.petparty_name or '' }}" data-respondent="{{ case.resparty_name or '' }}" data-establishment="{{ case.establishment_name or '' }}"
                        data-court="{{ case.court_no_desg_name or '' }}" data-type="{{ case.type_name or '' }}" data-next-date="{{ case.date_next_list or '' }}">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div class="form-check">
                                <input class="form-check-input case-selection" type="checkbox" data-cino="{{ case.cino }}" onchange="updateCaseSelection()">
                                <label class="form-check-label fw-bold">
                                    {{ case.case_no or 'N/A' }}
                                </label>
                            </div>
                            <span class="badge bg-info text-white">Upcoming</span>
                        </div>
                        <div class="card-body">
                            <h6 class="card-title text-primary">{{ case.case_no or 'N/A' }}</h6>
                            <div class="case-parties row mb-2">
                                <div class="col-6">
                                    <small class="text-muted">Petitioner:</small>
                                    <div class="fw-medium">{{ case.petparty_name or 'N/A' }}</div>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Respondent:</small>
                                    <div class="fw-medium">{{ case.resparty_name or 'N/A' }}</div>
                                </div>
                            </div>
                            <div class="case-details mb-2">
                                <small class="text-muted">Court:</small>
                                <div>{{ case.court_no_desg_name or 'N/A' }}</div>
                                <small class="text-muted mt-1">Next Hearing:</small>
                                <div class="input-group input-group-sm">
                                    <input type="date" class="form-control form-control-sm hearing-date-input" value="{{ case.date_next_list or '' }}" data-cino="{{ case.cino }}" onchange="updateHearingDate('{{ case.cino }}', this.value)">
                                    <button class="btn btn-outline-secondary btn-sm" type="button" onclick="clearHearingDate('{{ case.cino }}')">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <small class="text-muted mt-1">Type:</small>
                                <div>{{ case.type_name or 'N/A' }}</div>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">Notes:</small>
                                <textarea class="form-control notes-input" rows="2" placeholder="Add your notes here...">{{ case.user_notes or '' }}</textarea>
                            </div>
                        </div>
                        <div class="card-footer">
                            <div class="d-flex gap-2 justify-content-between">
                                <div class="d-flex gap-1">
                                    <button class="btn btn-primary btn-sm" onclick="openCaseDetail('{{ case.cino }}')">
                                        <i class="fas fa-eye me-2"></i> View
                                    </button> {% if case.is_changed %}
                                    <button class="btn btn-success btn-sm" onclick="markAsReviewed('{{ case.cino }}')">
                                            <i class="fas fa-check me-2"></i> Mark Reviewed
                                        </button> {% else %}
                                    <button class="btn btn-outline-warning btn-sm" onclick="removeFromReviewed('{{ case.cino }}')">
                                            <i class="fas fa-undo me-2"></i> Unmark
                                        </button> {% endif %}
                                </div>
                                <div class="d-flex align-items-center">
                                    {% if case.user_side %}
                                    <span class="badge bg-info">{{ case.user_side.title() }}</span> {% else %}
                                    <button class="btn btn-outline-secondary btn-sm" onclick="showUserSideModal('{{ case.cino }}', '')">
                                            <i class="fas fa-user-tag me-2"></i> Set Side
                                        </button> {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Disposed Cases Tab -->
        <div class="tab-pane fade" id="disposed-cases" role="tabpanel">
            <div class="row" id="disposedCasesContainer">
                {% for case in disposed_cases %}
                <div class="col-xl-4 col-lg-6 col-md-6 mb-4">
                    <div class="card case-card" data-cino="{{ case.cino }}" data-case-no="{{ case.case_no or '' }}" data-petitioner="{{ case.petparty_name or '' }}" data-respondent="{{ case.resparty_name or '' }}" data-establishment="{{ case.establishment_name or '' }}"
                        data-court="{{ case.court_no_desg_name or '' }}" data-type="{{ case.type_name or '' }}" data-next-date="{{ case.date_next_list or '' }}">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div class="form-check">
                                <input class="form-check-input case-selection" type="checkbox" data-cino="{{ case.cino }}" onchange="updateCaseSelection()">
                                <label class="form-check-label fw-bold">
                                    {{ case.case_no or 'N/A' }}
                                </label>
                            </div>
                            <span class="badge bg-danger text-white">Disposed</span>
                        </div>
                        <div class="card-body">
                            <h6 class="card-title text-primary">{{ case.case_no or 'N/A' }}</h6>
                            <div class="case-parties row mb-2">
                                <div class="col-6">
                                    <small class="text-muted">Petitioner:</small>
                                    <div class="fw-medium">{{ case.petparty_name or 'N/A' }}</div>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Respondent:</small>
                                    <div class="fw-medium">{{ case.resparty_name or 'N/A' }}</div>
                                </div>
                            </div>
                            <div class="case-details mb-2">
                                <small class="text-muted">Court:</small>
                                <div>{{ case.court_no_desg_name or 'N/A' }}</div>
                                {% if case.date_of_decision %}
                                <small class="text-muted mt-1">Date of Decision:</small>
                                <div class="text-danger fw-medium">{{ case.date_of_decision }}</div>
                                {% endif %}
                                <small class="text-muted mt-1">Disposition:</small>
                                <div>{{ case.disp_name or 'N/A' }}</div>
                                <small class="text-muted mt-1">Type:</small>
                                <div>{{ case.type_name or 'N/A' }}</div>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">Notes:</small>
                                <textarea class="form-control notes-input" rows="2" placeholder="Add your notes here...">{{ case.user_notes or '' }}</textarea>
                            </div>
                        </div>
                        <div class="card-footer">
                            <div class="d-flex gap-2 justify-content-between">
                                <div class="d-flex gap-1">
                                    <button class="btn btn-primary btn-sm" onclick="openCaseDetail('{{ case.cino }}')">
                                        <i class="fas fa-eye me-2"></i> View
                                    </button>
                                    <button class="btn btn-outline-info btn-sm" onclick="markAsReviewed('{{ case.cino }}')">
                                        <i class="fas fa-archive me-2"></i> Archive
                                    </button>
                                </div>
                                <div class="d-flex align-items-center">
                                    {% if case.user_side %}
                                    <span class="badge bg-info">{{ case.user_side.title() }}</span> {% else %}
                                    <button class="btn btn-outline-secondary btn-sm" onclick="showUserSideModal('{{ case.cino }}', '')">
                                            <i class="fas fa-user-tag me-2"></i> Set Side
                                        </button> {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Calendar Action Modal -->
<div class="modal fade" id="calendarActionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-calendar-alt me-2"></i>Calendar Actions for Cases
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card border-info">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0">Selected Cases</h6>
                            </div>
                            <div class="card-body text-center">
                                <h3 class="text-info" id="modalSelectedCount">0</h3>
                                <p class="mb-0">Cases Selected</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-secondary">
                            <div class="card-header bg-secondary text-white">
                                <h6 class="mb-0">All Cases in Tab</h6>
                            </div>
                            <div class="card-body text-center">
                                <h3 class="text-secondary" id="modalAllCount">0</h3>
                                <p class="mb-0">Total in Current Tab</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <button class="btn btn-success w-100 mb-2" onclick="executeCalendarAction('create', 'selected')">
                            <i class="fas fa-calendar-plus me-2"></i>Create Calendar for Selected
                        </button>
                        <button class="btn btn-outline-danger w-100" onclick="executeCalendarAction('delete', 'selected')">
                            <i class="fas fa-calendar-times me-2"></i>Delete Events for Selected
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-primary w-100 mb-2" onclick="executeCalendarAction('create', 'all')">
                            <i class="fas fa-calendar-plus me-2"></i>Create Calendar for All
                        </button>
                        <button class="btn btn-outline-danger w-100" onclick="executeCalendarAction('delete', 'all')">
                            <i class="fas fa-calendar-times me-2"></i>Delete Events for All
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete ALL Cases Modal -->
<div class="modal fade" id="deleteAllModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>Delete ALL Cases & Calendar Events
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-2 fw-bold text-danger">This action cannot be undone.<br>All cases and related calendar events will be deleted.</p>
                <div class="form-check mb-2">
                    <input type="checkbox" class="form-check-input" id="confirmDeleteDataCheck" onchange="validateDeletionForm()">
                    <label class="form-check-label" for="confirmDeleteDataCheck">I understand the consequences.</label>
                </div>
                <div class="mb-2">
                    <input type="text" class="form-control" id="confirmationText" placeholder='Type "DELETE_ALL_FOREVER" to confirm' oninput="validateDeletionForm()">
                </div>
                <button class="btn btn-danger w-100" id="confirmDeleteAllBtn" onclick="executeDeleteAll()" disabled>
                    <i class="fas fa-trash me-2"></i> Confirm Delete ALL
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Law Firm Case Management JavaScript - Template-Safe Version

    // Global Variables
    let originalCounts = {};
    let currentFilters = {
        text: '',
        dateFrom: '',
        dateTo: '',
        advanced: {}
    };
    let selectedCases = new Set();
    let currentTab = 'all-cases';
    let pendingChanges = new Set();
    let allCasesData = [];

    // Initialize everything when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        console.log('🚀 Initializing Law Firm Case Management System...');

        // Store original counts from tab badges - TEMPLATE SAFE
        const countElements = {
            'all-cases': document.getElementById('all-cases-count'),
            'active-cases': document.getElementById('active-cases-count'),
            'changed-cases': document.getElementById('changed-cases-count'),
            'upcoming-cases': document.getElementById('upcoming-cases-count'),
            'reviewed-cases': document.getElementById('reviewed-cases-count'),
            'disposed-cases': document.getElementById('disposed-cases-count')
        };

        // Safely extract counts
        originalCounts = {};
        Object.keys(countElements).forEach(tabId => {
            const element = countElements[tabId];
            originalCounts[tabId] = element ? parseInt(element.textContent || '0') : 0;
        });

        console.log('📊 Original counts stored:', originalCounts);

        initializeSearch();
        setupEventHandlers();
        initializeSelectAllButtons();
        updateCaseSelection();

        console.log('✅ App initialized successfully');
    });

    // Initialize search data - TEMPLATE SAFE
    function initializeSearch() {
        console.log('🔍 Initializing search...');

        const caseCards = document.querySelectorAll('.case-card');
        allCasesData = Array.from(caseCards).map(card => {
            const container = card.closest('.col-xl-4, .col-lg-6, .col-md-6, .col-12');
            return {
                element: container,
                cino: card.getAttribute('data-cino') || '',
                caseNo: card.getAttribute('data-case-no') || '',
                petitioner: card.getAttribute('data-petitioner') || '',
                respondent: card.getAttribute('data-respondent') || '',
                establishment: card.getAttribute('data-establishment') || '',
                nextDate: card.getAttribute('data-next-date') || '',
                isChanged: card.getAttribute('data-changed') === 'true',
                hasNotes: card.querySelector('.notes-input') ? card.querySelector('.notes-input').value.trim() !== '' : false
            };
        });

        console.log(`📋 Search initialized with ${allCasesData.length} cases`);
    }

    // Setup event handlers - TEMPLATE SAFE
    function setupEventHandlers() {
        // Search input handlers
        const searchInput = document.getElementById('searchInput');
        const dateFromInput = document.getElementById('dateFromInput');
        const dateToInput = document.getElementById('dateToInput');

        if (searchInput) {
            searchInput.addEventListener('input', handleSearch);
            searchInput.addEventListener('keyup', handleSearch);
        }

        if (dateFromInput) {
            dateFromInput.addEventListener('change', handleSearch);
            dateFromInput.addEventListener('input', handleSearch);
        }

        if (dateToInput) {
            dateToInput.addEventListener('change', handleSearch);
            dateToInput.addEventListener('input', handleSearch);
        }

        // Case selection handlers
        const caseCheckboxes = document.querySelectorAll('.case-selection');
        caseCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                updateCaseSelection();
            });
        });

        // Notes change handlers
        document.addEventListener('input', function(event) {
            if (event.target && event.target.classList.contains('notes-input')) {
                const card = event.target.closest('.case-card');
                if (card) {
                    const cino = card.getAttribute('data-cino');
                    if (cino) {
                        markCaseModified(cino);
                    }
                }
            }
        });
    }

    // Initialize select all buttons - TEMPLATE SAFE
    function initializeSelectAllButtons() {
        const selectAllButtons = document.querySelectorAll('[data-toggle-select]');
        selectAllButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const tabId = this.getAttribute('data-toggle-select');
                toggleAllSelection(tabId);
            });
        });
    }

    // Handle search functionality - ENHANCED
    function handleSearch() {
        console.log('🔍 Handling search...');

        const searchInputEl = document.getElementById('searchInput');
        const dateFromInputEl = document.getElementById('dateFromInput');
        const dateToInputEl = document.getElementById('dateToInput');

        const searchText = searchInputEl ? searchInputEl.value : '';
        const dateFrom = dateFromInputEl ? dateFromInputEl.value : '';
        const dateTo = dateToInputEl ? dateToInputEl.value : '';

        currentFilters = {
            text: searchText.trim(),
            dateFrom: dateFrom,
            dateTo: dateTo,
            advanced: currentFilters.advanced || {}
        };

        console.log('Current filters:', currentFilters);
        filterCases();
    }

    // Main filter function - TEMPLATE SAFE AND ENHANCED
    function filterCases() {
        console.log('🔍 Applying filters...');
        let visibleCount = 0;

        // Get all tab panes
        const tabPanes = {
            'all-cases': document.getElementById('all-cases'),
            'active-cases': document.getElementById('active-cases'),
            'changed-cases': document.getElementById('changed-cases'),
            'upcoming-cases': document.getElementById('upcoming-cases'),
            'reviewed-cases': document.getElementById('reviewed-cases'),
            'disposed-cases': document.getElementById('disposed-cases')
        };

        // Apply filtering to ALL tabs
        Object.keys(tabPanes).forEach(tabId => {
            const tabPane = tabPanes[tabId];
            if (!tabPane) return;

            const casesToFilter = tabPane.querySelectorAll('.case-card');
            let tabVisibleCount = 0;

            casesToFilter.forEach(card => {
                const container = card.closest('.col-xl-4, .col-lg-6, .col-md-6, .col-12');
                if (!container) return;

                let matches = true;

                // SAFE: Use getAttribute instead of dataset
                const caseData = {
                    cino: (card.getAttribute('data-cino') || '').toLowerCase(),
                    caseNo: (card.getAttribute('data-case-no') || '').toLowerCase(),
                    petitioner: (card.getAttribute('data-petitioner') || '').toLowerCase(),
                    respondent: (card.getAttribute('data-respondent') || '').toLowerCase(),
                    establishment: (card.getAttribute('data-establishment') || '').toLowerCase(),
                    nextDate: card.getAttribute('data-next-date') || '',
                    notes: ''
                };

                // Get notes from input field safely
                const notesInput = card.querySelector('.notes-input');
                if (notesInput) {
                    caseData.notes = (notesInput.value || '').toLowerCase();
                }

                // Text search filtering
                if (currentFilters.text) {
                    const searchTerm = currentFilters.text.toLowerCase();
                    matches = matches && (
                        caseData.cino.includes(searchTerm) ||
                        caseData.caseNo.includes(searchTerm) ||
                        caseData.petitioner.includes(searchTerm) ||
                        caseData.respondent.includes(searchTerm) ||
                        caseData.establishment.includes(searchTerm) ||
                        caseData.notes.includes(searchTerm)
                    );
                }

                // Date filtering with proper comparison
                if ((currentFilters.dateFrom || currentFilters.dateTo) && caseData.nextDate) {
                    try {
                        const caseDate = new Date(caseData.nextDate);
                        if (!isNaN(caseDate.getTime())) {
                            if (currentFilters.dateFrom) {
                                const fromDate = new Date(currentFilters.dateFrom);
                                if (caseDate < fromDate) {
                                    matches = false;
                                }
                            }
                            if (currentFilters.dateTo) {
                                const toDate = new Date(currentFilters.dateTo);
                                toDate.setHours(23, 59, 59, 999);
                                if (caseDate > toDate) {
                                    matches = false;
                                }
                            }
                        } else {
                            if (currentFilters.dateFrom || currentFilters.dateTo) {
                                matches = false;
                            }
                        }
                    } catch (e) {
                        console.error('Date parsing error:', e);
                        matches = false;
                    }
                } else if (currentFilters.dateFrom || currentFilters.dateTo) {
                    matches = false;
                }

                // Apply visibility
                container.style.display = matches ? 'block' : 'none';
                if (matches) {
                    tabVisibleCount++;
                    // Count for active tab only for search results display
                    const activeTabPane = document.querySelector('.tab-pane.active');
                    if (activeTabPane && activeTabPane.id === tabId) {
                        visibleCount++;
                    }
                }
            });
        });

        updateSearchResultsCount(visibleCount);
        updateToggleButtonState();
        updateTabCounts();
    }

    // Update tab counts based on filtered results - TEMPLATE SAFE
    function updateTabCounts() {
        console.log('📊 Updating tab counts based on filters...');

        const tabPanes = {
            'all-cases': document.getElementById('all-cases'),
            'active-cases': document.getElementById('active-cases'),
            'changed-cases': document.getElementById('changed-cases'),
            'upcoming-cases': document.getElementById('upcoming-cases'),
            'reviewed-cases': document.getElementById('reviewed-cases'),
            'disposed-cases': document.getElementById('disposed-cases')
        };

        Object.keys(tabPanes).forEach(tabId => {
            const tabPane = tabPanes[tabId];
            const countElement = document.getElementById(tabId + '-count');

            if (tabPane && countElement) {
                // Count visible cases in this tab
                const allCasesInTab = tabPane.querySelectorAll('.case-card');
                const visibleCases = Array.from(allCasesInTab).filter(card => {
                    const container = card.closest('.col-xl-4, .col-lg-6, .col-md-6, .col-12');
                    return container && container.style.display !== 'none';
                }).length;

                // Update count text
                countElement.textContent = visibleCases;

                // Update badge color based on filtering status
                const isFiltered = currentFilters.text || currentFilters.dateFrom || currentFilters.dateTo;
                if (isFiltered && visibleCases < originalCounts[tabId]) {
                    countElement.className = getFilteredBadgeClass(tabId);
                } else {
                    countElement.className = getOriginalBadgeClass(tabId);
                }

                console.log(`Updated ${tabId}: ${visibleCases}/${originalCounts[tabId]} cases`);
            }
        });
    }

    // Get original badge classes for each tab
    function getOriginalBadgeClass(tabId) {
        const badgeClasses = {
            'all-cases': 'badge bg-light text-dark',
            'active-cases': 'badge bg-light text-dark',
            'changed-cases': 'badge bg-warning text-dark',
            'upcoming-cases': 'badge bg-info text-white',
            'reviewed-cases': 'badge bg-success text-white',
            'disposed-cases': 'badge bg-danger text-white'
        };
        return badgeClasses[tabId] || 'badge bg-light text-dark';
    }

    // Get filtered badge classes
    function getFilteredBadgeClass(tabId) {
        const filteredBadgeClasses = {
            'all-cases': 'badge bg-primary text-white',
            'active-cases': 'badge bg-primary text-white',
            'changed-cases': 'badge bg-warning text-dark',
            'upcoming-cases': 'badge bg-info text-white',
            'reviewed-cases': 'badge bg-success text-white',
            'disposed-cases': 'badge bg-danger text-white'
        };
        return filteredBadgeClasses[tabId] || 'badge bg-primary text-white';
    }

    // Update case selection tracking - TEMPLATE SAFE
    function updateCaseSelection() {
        selectedCases.clear();
        const checkedBoxes = document.querySelectorAll('.case-selection:checked');
        checkedBoxes.forEach(checkbox => {
            const cino = checkbox.getAttribute('data-cino');
            if (cino) {
                selectedCases.add(cino);
            }
        });

        updateBulkActions();
        updateToggleButtonState();
    }

    // Update bulk actions - TEMPLATE SAFE
    function updateBulkActions() {
        const count = selectedCases.size;
        const container = document.getElementById('bulkActionsContainer');
        const text = document.getElementById('selectedCasesText');
        const markBtn = document.getElementById('bulkMarkReviewedBtn');
        const removeBtn = document.getElementById('bulkRemoveReviewedBtn');
        const calendarBtn = document.getElementById('bulkCalendarBtn');

        if (count > 0) {
            showBulkMenu();
            if (text) text.textContent = count + ' case' + (count > 1 ? 's' : '') + ' selected';
            if (markBtn) markBtn.disabled = false;
            if (removeBtn) removeBtn.disabled = false;
            if (calendarBtn) calendarBtn.disabled = false;
        } else {
            hideBulkMenu();
            if (text) text.textContent = '0 cases selected';
            if (markBtn) markBtn.disabled = true;
            if (removeBtn) removeBtn.disabled = true;
            if (calendarBtn) calendarBtn.disabled = true;
        }
    }

    // Show bulk menu
    function showBulkMenu() {
        const bulkContainer = document.getElementById('bulkActionsContainer');
        if (bulkContainer) {
            bulkContainer.style.display = 'block';
            bulkContainer.classList.add('show');
        }
    }

    // Hide bulk actions menu
    function hideBulkMenu() {
        const bulkContainer = document.getElementById('bulkActionsContainer');
        if (bulkContainer) {
            bulkContainer.style.display = 'none';
            bulkContainer.classList.remove('show');
        }
    }

    // Set date filter with enhanced functionality - TEMPLATE SAFE
    function setDateFilter(period) {
        console.log('📅 Setting date filter:', period);

        const today = new Date();
        const dateFromInput = document.getElementById('dateFromInput');
        const dateToInput = document.getElementById('dateToInput');

        if (!dateFromInput || !dateToInput) {
            console.error('Date input fields not found');
            return;
        }

        let fromDate = '';
        let toDate = '';

        switch (period) {
            case 'today':
                fromDate = toDate = today.toISOString().split('T')[0];
                break;
            case 'thisWeek':
                const startOfWeek = new Date(today);
                startOfWeek.setDate(today.getDate() - today.getDay());
                const endOfWeek = new Date(startOfWeek);
                endOfWeek.setDate(startOfWeek.getDate() + 6);
                fromDate = startOfWeek.toISOString().split('T');
                toDate = endOfWeek.toISOString().split('T');
                break;
            case 'thisMonth':
                fromDate = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T');
                toDate = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T');
                break;
            case 'nextWeek':
                const nextWeekStart = new Date(today);
                nextWeekStart.setDate(today.getDate() + (7 - today.getDay()));
                const nextWeekEnd = new Date(nextWeekStart);
                nextWeekEnd.setDate(nextWeekStart.getDate() + 6);
                fromDate = nextWeekStart.toISOString().split('T');
                toDate = nextWeekEnd.toISOString().split('T');
                break;
            case 'all':
                fromDate = toDate = '';
                break;
            default:
                fromDate = toDate = '';
                break;
        }

        dateFromInput.value = fromDate;
        dateToInput.value = toDate;
        currentFilters.dateFrom = fromDate;
        currentFilters.dateTo = toDate;

        // Update button states
        const dateFilterButtons = document.querySelectorAll('#dateFilterGroup .btn');
        dateFilterButtons.forEach(btn => {
            btn.classList.remove('active');
        });

        // Find and activate the correct button
        const targetButton = document.querySelector('[onclick*="' + period + '"]');
        if (targetButton) {
            targetButton.classList.add('active');
        }

        console.log('Date filter set: ' + fromDate + ' to ' + toDate);
        filterCases();
    }

    // Clear all filters and reset counts
    function clearAllFilters() {
        console.log('🧹 Clearing all filters...');

        const searchInput = document.getElementById('searchInput');
        const dateFromInput = document.getElementById('dateFromInput');
        const dateToInput = document.getElementById('dateToInput');

        if (searchInput) searchInput.value = '';
        if (dateFromInput) dateFromInput.value = '';
        if (dateToInput) dateToInput.value = '';

        // Reset date filter buttons
        const dateFilterButtons = document.querySelectorAll('#dateFilterGroup .btn');
        dateFilterButtons.forEach(btn => {
            btn.classList.remove('active');
        });

        currentFilters = {
            text: '',
            dateFrom: '',
            dateTo: '',
            advanced: {}
        };

        // Show all cases and update counts
        const allCaseCards = document.querySelectorAll('.case-card');
        allCaseCards.forEach(card => {
            const container = card.closest('.col-xl-4, .col-lg-6, .col-md-6, .col-12');
            if (container) {
                container.style.display = 'block';
            }
        });

        resetTabCounts();
        updateToggleButtonState();

        const activeTabPane = document.querySelector('.tab-pane.active');
        const activeTabCases = activeTabPane ? activeTabPane.querySelectorAll('.case-card') : [];
        updateSearchResultsCount(activeTabCases.length);

        console.log('✅ All filters cleared and tab counts reset');
    }

    // Reset tab counts to original values
    function resetTabCounts() {
        console.log('🔄 Resetting tab counts to original values...');
        Object.keys(originalCounts).forEach(tabId => {
            const countElement = document.getElementById(tabId + '-count');
            if (countElement) {
                countElement.textContent = originalCounts[tabId];
                countElement.className = getOriginalBadgeClass(tabId);
                console.log('Reset ' + tabId + ' count to ' + originalCounts[tabId]);
            }
        });
    }

    // Toggle all selection - TEMPLATE SAFE
    function toggleAllSelection(tabId) {
        console.log('🔄 Toggling selection for tab:', tabId);
        const activeTabPane = document.querySelector('.tab-pane.active');
        if (!activeTabPane) return;

        const allCheckboxes = activeTabPane.querySelectorAll('.case-selection');
        const visibleCheckboxes = Array.from(allCheckboxes).filter(checkbox => {
            const container = checkbox.closest('.col-xl-4, .col-lg-6, .col-md-6, .col-12');
            return container && container.style.display !== 'none';
        });

        if (visibleCheckboxes.length === 0) return;

        const allSelected = visibleCheckboxes.every(checkbox => checkbox.checked);
        const toggleButton = document.querySelector('[data-toggle-select="' + tabId + '"] span');

        if (allSelected) {
            // Deselect all
            visibleCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
                const cino = checkbox.getAttribute('data-cino');
                if (cino) {
                    selectedCases.delete(cino);
                }
            });
            if (toggleButton) {
                toggleButton.textContent = 'Select All';
                toggleButton.parentElement.classList.remove('btn-primary');
                toggleButton.parentElement.classList.add('btn-outline-primary');
            }
            hideBulkMenu();
        } else {
            // Select all
            visibleCheckboxes.forEach(checkbox => {
                checkbox.checked = true;
                const cino = checkbox.getAttribute('data-cino');
                if (cino) {
                    selectedCases.add(cino);
                }
            });
            if (toggleButton) {
                toggleButton.textContent = 'Deselect All';
                toggleButton.parentElement.classList.remove('btn-outline-primary');
                toggleButton.parentElement.classList.add('btn-primary');
            }
            showBulkMenu();
        }

        updateBulkActions();
        console.log((allSelected ? 'Deselected' : 'Selected') + ' ' + visibleCheckboxes.length + ' cases');
    }

    // Update toggle button state - TEMPLATE SAFE
    function updateToggleButtonState() {
        const activeTabPane = document.querySelector('.tab-pane.active');
        if (!activeTabPane) return;

        const tabId = activeTabPane.id;
        const toggleButton = document.querySelector('[data-toggle-select="' + tabId + '"] span');

        if (toggleButton) {
            const allCheckboxes = activeTabPane.querySelectorAll('.case-selection');
            const visibleCheckboxes = Array.from(allCheckboxes).filter(checkbox => {
                const container = checkbox.closest('.col-xl-4, .col-lg-6, .col-md-6, .col-12');
                return container && container.style.display !== 'none';
            });

            const checkedCount = visibleCheckboxes.filter(cb => cb.checked).length;
            const allSelected = visibleCheckboxes.length > 0 && checkedCount === visibleCheckboxes.length;

            toggleButton.textContent = allSelected ? 'Deselect All' : 'Select All';
            const buttonElement = toggleButton.parentElement;
            if (allSelected) {
                buttonElement.classList.remove('btn-outline-primary');
                buttonElement.classList.add('btn-primary');
            } else {
                buttonElement.classList.remove('btn-primary');
                buttonElement.classList.add('btn-outline-primary');
            }
        }
    }

    // Update search results count
    function updateSearchResultsCount(count) {
        const countElement = document.getElementById('searchResultsCount');
        if (countElement) {
            countElement.textContent = count;
            countElement.className = count > 0 ? 'badge bg-primary' : 'badge bg-warning';
        }
    }

    // Tab switching functionality
    function switchTab(tabName) {
        console.log('🔄 Switching to tab:', tabName);
        currentTab = tabName;
        selectedCases.clear();
        hideBulkMenu();

        const selectAllSpans = document.querySelectorAll('[data-toggle-select] span');
        selectAllSpans.forEach(span => {
            span.textContent = 'Select All';
            span.parentElement.classList.remove('btn-primary');
            span.parentElement.classList.add('btn-outline-primary');
        });

        // Apply filters to new tab after a short delay
        setTimeout(function() {
            filterCases();
            updateCaseSelection();
            updateToggleButtonState();
        }, 100);
    }

    // Mark case as modified
    function markCaseModified(cino) {
        pendingChanges.add(cino);
    }

    // Case action functions
    function openCaseDetail(cino) {
        window.location.href = '/case/' + cino;
    }

    // Utility functions
    function showAlert(message, type) {
        type = type || 'info';
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-' + type + ' alert-dismissible fade show position-fixed';
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
        alertDiv.innerHTML = message + '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';

        document.body.appendChild(alertDiv);

        setTimeout(function() {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }

    function hasActiveFilters() {
        return !!(currentFilters.text || currentFilters.dateFrom || currentFilters.dateTo);
    }

    // Global functions for template use
    window.setDateFilter = setDateFilter;
    window.clearAllFilters = clearAllFilters;
    window.switchTab = switchTab;
    window.openCaseDetail = openCaseDetail;
    window.toggleAllSelection = toggleAllSelection;
    window.showAlert = showAlert;

    console.log('📋 Law Firm Case Management System loaded successfully');
</script>


<style>
    .nav-tabs .nav-item {
        position: relative;
        flex: 1;
    }
    
    .nav-tabs .nav-link {
        padding-right: 100px;
    }
    
    .nav-tabs .btn {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
    
    .hearing-date-input {
        font-size: 0.875rem;
    }
    
    #bulkActionsContainer {
        border-left: 4px solid var(--bs-primary);
    }
    
    .nav-tabs .badge {
        transition: all 0.3s ease;
    }
    
    .nav-tabs .badge.filtered {
        background-color: #ffc107 !important;
        color: #000 !important;
    }
</style>
{% endblock %}