{% extends "base.html" %} {% block title %}Create New Case - e-Courts Case Management{% endblock %} {% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="text-primary">
                    <i class="fas fa-plus-circle"></i> Create New Case
                </h2>
                <a href="{{ url_for('dashboard') }}" class="btn btn-outline-primary">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </div>
    </div>

    <!-- Case Creation Form -->
    <div class="row">
        <div class="col-lg-8 offset-lg-2">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-gavel"></i> Case Information
                    </h5>
                </div>
                <div class="card-body">
                    <form id="createCaseForm">
                        <!-- Basic Information -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2 mb-3">Basic Information</h6>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="cino" class="form-label">CINO *</label>
                                <input type="text" class="form-control" id="cino" name="cino" required placeholder="e.g., MHPU040389712018">
                                <small class="form-text text-muted">Court Information System Number</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="case_no" class="form-label">Case Number *</label>
                                <input type="text" class="form-control" id="case_no" name="case_no" required placeholder="e.g., 201900028562018">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="type_name" class="form-label">Case Type *</label>
                                <input type="text" class="form-control" id="type_name" name="type_name" required placeholder="e.g., Cri.M.A.">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="reg_no" class="form-label">Registration Number</label>
                                <input type="number" class="form-control" id="reg_no" name="reg_no" placeholder="e.g., 2856">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="reg_year" class="form-label">Registration Year</label>
                                <input type="number" class="form-control" id="reg_year" name="reg_year" min="2000" max="2030" placeholder="e.g., 2018">
                            </div>
                        </div>

                        <!-- Party Information -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2 mb-3">Party Information</h6>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="petparty_name" class="form-label">Petitioner Name *</label>
                                <input type="text" class="form-control" id="petparty_name" name="petparty_name" required placeholder="Enter petitioner's name">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="resparty_name" class="form-label">Respondent Name *</label>
                                <input type="text" class="form-control" id="resparty_name" name="resparty_name" required placeholder="Enter respondent's name">
                            </div>
                            <div class="col-12 mb-3">
                                <label class="form-label">Your Side</label>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="user_side" id="petitioner_side" value="petitioner">
                                            <label class="form-check-label" for="petitioner_side">
                                                <i class="fas fa-user-tie text-primary"></i> I am the Petitioner
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="user_side" id="respondent_side" value="respondent">
                                            <label class="form-check-label" for="respondent_side">
                                                <i class="fas fa-user-shield text-danger"></i> I am the Respondent
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Court Information -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2 mb-3">Court Information</h6>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="establishment_name" class="form-label">Establishment Name</label>
                                <input type="text" class="form-control" id="establishment_name" name="establishment_name" placeholder="e.g., J.M.F.C.COURT PUNE MAHARASHTRA">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="court_no_desg_name" class="form-label">Court/Judge Details</label>
                                <input type="text" class="form-control" id="court_no_desg_name" name="court_no_desg_name" placeholder="e.g., 8TH JOINT CIVIL JUDGE J.D. AND JMFC PUNE.">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="state_name" class="form-label">State</label>
                                <input type="text" class="form-control" id="state_name" name="state_name" placeholder="e.g., Maharashtra">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="district_name" class="form-label">District</label>
                                <input type="text" class="form-control" id="district_name" name="district_name" placeholder="e.g., Pune">
                            </div>
                        </div>

                        <!-- Hearing Information -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2 mb-3">Hearing Information</h6>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="date_next_list" class="form-label">Next Hearing Date</label>
                                <input type="date" class="form-control" id="date_next_list" name="date_next_list">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="purpose_name" class="form-label">Purpose</label>
                                <input type="text" class="form-control" id="purpose_name" name="purpose_name" placeholder="e.g., Unready Board">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="date_last_list" class="form-label">Last Hearing Date</label>
                                <input type="date" class="form-control" id="date_last_list" name="date_last_list">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="disp_name" class="form-label">Disposition</label>
                                <input type="text" class="form-control" id="disp_name" name="disp_name" placeholder="e.g., JUDGMENT">
                            </div>
                        </div>

                        <!-- Notes -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2 mb-3">Additional Information</h6>
                            </div>
                            <div class="col-12 mb-3">
                                <label for="user_notes" class="form-label">Your Notes</label>
                                <textarea class="form-control" id="user_notes" name="user_notes" rows="4" placeholder="Add any notes or remarks about this case..."></textarea>
                            </div>
                        </div>

                        <!-- Buttons -->
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex justify-content-end gap-2">
                                    <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                                        <i class="fas fa-undo"></i> Reset Form
                                    </button>
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-save"></i> Create Case
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mb-0">Creating case...</p>
            </div>
        </div>
    </div>
</div>

<script>
    function showLoading() {
        const modal = new bootstrap.Modal(document.getElementById('loadingModal'));
        modal.show();
    }

    function hideLoading() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('loadingModal'));
        if (modal) modal.hide();
    }

    function showAlert(message, type = 'info') {
        // Remove existing alerts
        document.querySelectorAll('.alert.position-fixed').forEach(alert => alert.remove());

        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

        document.body.appendChild(alertDiv);

        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }

    function resetForm() {
        document.getElementById('createCaseForm').reset();
    }

    function validateForm() {
        const requiredFields = ['cino', 'case_no', 'petparty_name', 'resparty_name', 'type_name'];

        for (let fieldId of requiredFields) {
            const field = document.getElementById(fieldId);
            if (!field.value.trim()) {
                showAlert(`Please fill in the ${field.labels[0].textContent.replace(' *', '')} field.`, 'warning');
                field.focus();
                return false;
            }
        }

        // Validate CINO format (basic check)
        const cino = document.getElementById('cino').value.trim();
        if (cino.length < 10) {
            showAlert('CINO should be at least 10 characters long.', 'warning');
            document.getElementById('cino').focus();
            return false;
        }

        return true;
    }

    // Form submission
    document.getElementById('createCaseForm').addEventListener('submit', function(e) {
        e.preventDefault();

        if (!validateForm()) {
            return;
        }

        const formData = new FormData(this);
        const caseData = {};

        // Convert FormData to object
        for (let [key, value] of formData.entries()) {
            // Convert numeric fields
            if (['reg_no', 'reg_year'].includes(key) && value) {
                caseData[key] = parseInt(value);
            } else {
                caseData[key] = value;
            }
        }

        showLoading();

        fetch('/create_case', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(caseData)
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.error) {
                    showAlert(data.error, 'danger');
                } else {
                    showAlert('Case created successfully!', 'success');
                    setTimeout(() => {
                        window.location.href = `/case/${data.cino}`;
                    }, 1500);
                }
            })
            .catch(error => {
                hideLoading();
                showAlert('Failed to create case: ' + error.message, 'danger');
            });
    });

    // Set current year as default for reg_year
    document.addEventListener('DOMContentLoaded', function() {
        const regYearInput = document.getElementById('reg_year');
        regYearInput.value = new Date().getFullYear();
    });
</script>

{% endblock %}